# Бизнес-процесс курьерской доставки (ASCII Art)

## Основной флоу системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   TEEZ_PVZ      │    │     COUBE       │    │    Логист       │    │     Курьер      │
│    Система      │    │   Platform      │    │  (Web Admin)    │    │   (Mobile)      │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │                      │
          │                      │                      │                      │
     ┌────▼────┐                 │                      │                      │
     │1. Товар │                 │                      │                      │
     │поступает│                 │                      │                      │
     │на склад │                 │                      │                      │
     └────┬────┘                 │                      │                      │
          │                      │                      │                      │
     ┌────▼────┐                 │                      │                      │
     │2.Создание│                │                      │                      │
     │марш.листа│                │                      │                      │
     │без курьера│               │                      │                      │
     └────┬────┘                 │                      │                      │
          │                      │                      │                      │
          │ POST /api/v1/courier/│                      │                      │
          │ waybill/upload        │                      │                      │
          ├─────────────────────►│                      │                      │
          │                      │                      │                      │
          │                 ┌────▼────┐                 │                      │
          │                 │3.Создание│                │                      │
          │                 │заявки    │                │                      │
          │                 │курьерского│               │                      │
          │                 │типа      │                │                      │
          │                 └────┬────┘                 │                      │
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  4.Редактирование МЛ │                      │
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  5.Назначение курьера│                      │
          │                      │                      │                      │
          │                      │                      │   Push notification  │
          │                      ├──────────────────────┼─────────────────────►│
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  6.Отправка В РАБОТУ │                      │
          │                      │                      │                      │
          │                      │                      │      Заявка в app    │
          │                      ├──────────────────────┼─────────────────────►│
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │7.Принять│
          │                      │                      │                 │Отклонить│
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │8."Начать│
          │                      │                      │                 │  путь"  │
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │9.Доставка│
          │                      │                      │                 │по точкам│
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │    ┌─────────────────┬──────────────────────┘
          │                      │    │     Статусы:    │
          │                      │    │ • Отдал + SMS   │ 
          │                      │    │ • Возврат       │
          │                      │    │ • Не отдал      │
          │                      │    │ • Не доехал     │
          │                      │    └─────────────────┤
          │                      │                      │   Обновление статусов
          │                      │◄─────────────────────┼──────────────────────┤
          │                      │                      │                      │
          │                 ┌────▼────┐                 │                      │
          │                 │10.Подсчет│                │                      │
          │                 │итогов и  │                │                      │
          │                 │завершение│                │                      │
          │                 └────┬────┘                 │                      │
          │                      │                      │                      │
          │ POST результаты      │                      │                      │
          │ в TEEZ_PVZ (async)   │                      │                      │
          │◄─────────────────────┤                      │                      │
          │                      │                      │                 ┌────▼────┐
     ┌────▼────┐                 │                      │                 │11.Возврат│
     │12.Получ.│                 │                      │                 │на склад │
     │итогов и │                 │                      │                 └─────────┘
     │сверка   │                 │                      │
     └─────────┘                 │                      │
                                 │                      │
                            ┌────▼────┐                 │
                            │13.Сверка│                 │
                            │на складе│                 │
                            │вручную  │                 │
                            └─────────┘                 │
```

## API Интеграционные точки

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                           🔌 ИНТЕГРАЦИОННЫЕ API                              ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  ВХОДЯЩИЕ (от TEEZ_PVZ → COUBE):                                            ║
║  ┌────────────────────────────────────────────────────────────────────────┐  ║
║  │ POST /api/v1/integration/teez/waybill/upload                           │  ║
║  │                                                                        │  ║
║  │ Request Body:                                                          │  ║
║  │ {                                                                      │  ║
║  │   "waybill": {                                                         │  ║
║  │     "id": 123,                                                         │  ║
║  │     "createdDate": "2025-04-15T07:39:00.360232Z"                      │  ║
║  │   },                                                                   │  ║
║  │   "deliveries": [                                                      │  ║
║  │     {                                                                  │  ║
║  │       "externalId": "123456",                                          │  ║
║  │       "address": "г. Астана, ул. Пушкина 1",                          │  ║
║  │       "receiver": {                                                    │  ║
║  │         "name": "Иван Иванов",                                         │  ║
║  │         "phone": "+77123456789"                                        │  ║
║  │       }                                                                │  ║
║  │     }                                                                  │  ║
║  │   ]                                                                    │  ║
║  │ }                                                                      │  ║
║  └────────────────────────────────────────────────────────────────────────┘  ║
║                                                                              ║
║  ИСХОДЯЩИЕ (COUBE → TEEZ_PVZ):                                              ║
║  ┌────────────────────────────────────────────────────────────────────────┐  ║
║  │ POST /api/waybill/results  (к их системе)                             │  ║
║  │                                                                        │  ║
║  │ Request Body:                                                          │  ║
║  │ {                                                                      │  ║
║  │   "orders": [                                                          │  ║
║  │     {                                                                  │  ║
║  │       "orderExternalId": "123456",                                     │  ║
║  │       "status": "delivered|returned|customer_not_accessed|...",        │  ║
║  │       "stateChangeDatetime": "2025-04-15T14:30:00Z"                   │  ║
║  │     }                                                                  │  ║
║  │   ],                                                                   │  ║
║  │   "additionalEvents": [                                                │  ║
║  │     {                                                                  │  ║
║  │       "orderExternalId": "789123",                                     │  ║
║  │       "eventType": "previous_order_not_received"                       │  ║
║  │     }                                                                  │  ║
║  │   ]                                                                    │  ║
║  │ }                                                                      │  ║
║  └────────────────────────────────────────────────────────────────────────┘  ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

## Статусы заказов

```
                    ┌─────────────┐
                    │   Создан    │ (загружен из TEEZ_PVZ)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  Назначен   │ (логист назначил курьера)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  В работе   │ (курьер принял заявку)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   В пути    │ ("начать путь")
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼─────┐    ┌──────▼──────┐    ┌─────▼──────┐
    │Доставлен │    │ Возвращен   │    │Не доставлен│
    │+ SMS код │    │(покупатель  │    │(клиент не  │
    │+ скан    │    │ вернул)     │    │ доступен)  │
    └──────────┘    └─────────────┘    └────────────┘
                                              │
                                       ┌──────▼──────┐
                                       │  Не доехал  │
                                       │ (курьер не  │
                                       │  добрался)  │
                                       └─────────────┘
```

## Структура данных (упрощенная)

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  WAYBILL        │────▶│     ORDER       │────▶│    ADDRESS      │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ id              │     │ id              │
│ external_id     │     │ external_id     │     │ full_address    │
│ created_date    │     │ barcode         │     │ latitude        │
│ status          │     │ status          │     │ longitude       │
│ courier_id      │     │ delivery_time   │     │ is_problematic  │
└─────────────────┘     │ verification    │     └─────────────────┘
                        └─────────────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    COURIER      │     │    GEOZONE      │     │INTEGRATION_LOG  │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ id              │     │ object_id       │
│ external_teez_id│     │ name            │     │ event_type      │
│ full_name       │     │ coordinates     │     │ success         │
│ phone           │     └─────────────────┘     │ error_message   │
│ active          │                             │ created_at      │
│ current_status  │                             └─────────────────┘
└─────────────────┘
```

## Асинхронная обработка

```
     COUBE завершает маршрут
              │
              ▼
    ┌─────────────────────┐
    │    PUB/SUB TABLE    │
    │ ┌─────────────────┐ │
    │ │ Event: send     │ │
    │ │ System: TEEZ    │ │  
    │ │ Data: results   │ │
    │ │ Status: pending │ │
    │ └─────────────────┘ │
    └─────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │ Background Service  │
    │ ┌─────────────────┐ │
    │ │ 1. Читает queue │ │
    │ │ 2. POST в TEEZ  │ │
    │ │ 3. Retry если   │ │
    │ │    ошибка       │ │
    │ │ 4. Логирует     │ │
    │ └─────────────────┘ │
    └─────────────────────┘
              │
    ┌─────────▼─────────┐
    │ Success: mark     │
    │ sent = true       │
    └───────────────────┘
              │
    ┌─────────▼─────────┐
    │ Error: retry      │
    │ every hour        │
    └───────────────────┘
```

---

## 🚀 Что нужно реализовать:

**Высокий приоритет:**
- [ ] API интеграции с TEEZ_PVZ (входящий/исходящий)  
- [ ] Новые справочники (курьеры, склады, статусы)
- [ ] PUB/SUB система для асинхронной отправки
- [ ] Логирование интеграционных событий

**Средний приоритет:**
- [ ] Расширение Driver API (SMS, сканы, возвраты)
- [ ] Валидации и бизнес-логика маршрутов
- [ ] Пометка проблемных адресов

**Низкий приоритет:**
- [ ] Аналитические отчеты
- [ ] Web интерфейс для логистов
- [ ] Excel выгрузки

---
*ASCII диаграммы совместимы с любыми текстовыми редакторами и системами*