# Бизнес-процесс курьерской доставки (ASCII Art)

## Основной флоу системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   TEEZ_PVZ      │    │     COUBE       │    │    Логист       │    │     Курьер      │
│    Система      │    │   Platform      │    │  (Web Admin)    │    │   (Mobile)      │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │                      │
          │                      │                      │                      │
     ┌────▼────┐                 │                      │                      │
     │1. Товар │                 │                      │                      │
     │поступает│                 │                      │                      │
     │на склад │                 │                      │                      │
     └────┬────┘                 │                      │                      │
          │                      │                      │                      │
     ┌────▼────┐                 │                      │                      │
     │2.Создание│                │                      │                      │
     │марш.листа│                │                      │                      │
     │без курьера│               │                      │                      │
     └────┬────┘                 │                      │                      │
          │                      │                      │                      │
          │ POST /api/v1/courier/│                      │                      │
          │ waybill/upload        │                      │                      │
          ├─────────────────────►│                      │                      │
          │                      │                      │                      │
          │                 ┌────▼────┐                 │                      │
          │                 │3.Создание│                │                      │
          │                 │заявки    │                │                      │
          │                 │курьерского│               │                      │
          │                 │типа      │                │                      │
          │                 └────┬────┘                 │                      │
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  4.Редактирование МЛ │                      │
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  5.Назначение курьера│                      │
          │                      │                      │                      │
          │                      │                      │   Push notification  │
          │                      ├──────────────────────┼─────────────────────►│
          │                      │                      │                      │
          │                      │    ◄─────────────────┤                      │
          │                      │  6.Отправка В РАБОТУ │                      │
          │                      │                      │                      │
          │                      │                      │      Заявка в app    │
          │                      ├──────────────────────┼─────────────────────►│
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │7.Принять│
          │                      │                      │                 │Отклонить│
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │8."Начать│
          │                      │                      │                 │  путь"  │
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │9.Доставка│
          │                      │                      │                 │по точкам│
          │                      │                      │                 └────┬────┘
          │                      │                      │                      │
          │                      │    ┌─────────────────┬──────────────────────┘
          │                      │    │     Статусы:    │
          │                      │    │ • Отдал + SMS   │ 
          │                      │    │ • Возврат       │
          │                      │    │ • Не отдал      │
          │                      │    │ • Не доехал     │
          │                      │    └─────────────────┤
          │                      │                      │   Обновление статусов
          │                      │◄─────────────────────┼──────────────────────┤
          │                      │                      │                      │
          │                 ┌────▼────┐                 │                      │
          │                 │10.Маршрут│                │                      │
          │                 │завершен  │                │                      │
          │                 │результаты│                │                      │
          │                 │готовы    │                │                      │
          │                 └────┬────┘                 │                      │
          │                      │                      │                      │
          │                      │                      │                 ┌────▼────┐
          │                      │                      │                 │11.Возврат│
          │                      │                      │                 │на склад │
          │                      │                      │                 └─────────┘
          │ GET статусы заказов  │                      │
          │ по track_numbers     │                      │
          │ (polling 5-10 мин)   │                      │
          ├─────────────────────►│                      │
          │                      │                      │
          │◄─────────────────────┤                      │
          │ Response: статусы    │                      │
          │                      │                      │
     ┌────▼────┐                 │                      │
     │12.Получ.│                 │                      │
     │статусов │                 │                      │
     │и сверка │                 │                      │
     └─────────┘                 │                      │
                                 │                      │
                            ┌────▼────┐                 │
                            │13.Сверка│                 │
                            │на складе│                 │
                            │вручную  │                 │
                            └─────────┘                 │
```

## API Интеграционные точки

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                           🔌 ИНТЕГРАЦИОННЫЕ API                              ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  ВХОДЯЩИЕ (от TEEZ_PVZ → COUBE):                                            ║
║  ┌────────────────────────────────────────────────────────────────────────┐  ║
║  │ POST /api/v1/integration/teez/waybill/upload                           │  ║
║  │                                                                        │  ║
║  │ Request Body:                                                          │  ║
║  │ {                                                                      │  ║
║  │   "waybill": {                                                         │  ║
║  │     "id": 123,                                                         │  ║
║  │     "createdDate": "2025-04-15T07:39:00.360232Z"                      │  ║
║  │   },                                                                   │  ║
║  │   "deliveries": [                                                      │  ║
║  │     {                                                                  │  ║
║  │       "externalId": "123456",                                          │  ║
║  │       "address": "г. Астана, ул. Пушкина 1",                          │  ║
║  │       "receiver": {                                                    │  ║
║  │         "name": "Иван Иванов",                                         │  ║
║  │         "phone": "+77123456789"                                        │  ║
║  │       }                                                                │  ║
║  │     }                                                                  │  ║
║  │   ]                                                                    │  ║
║  │ }                                                                      │  ║
║  └────────────────────────────────────────────────────────────────────────┘  ║
║                                                                              ║
║  ИСХОДЯЩИЕ (TEEZ_PVZ → COUBE):                                              ║
║  ┌────────────────────────────────────────────────────────────────────────┐  ║
║  │ GET /api/v1/integration/courier/orders/status                         │  ║
║  │     ?track_numbers=TRACK-123,TRACK-456,TRACK-789                      │  ║
║  │     &source_system=TEEZ_PVZ                                           │  ║
║  │                                                                        │  ║
║  │ Headers:                                                               │  ║
║  │   X-API-Key: {teez-api-key}                                           │  ║
║  │                                                                        │  ║
║  │ Response Body:                                                         │  ║
║  │ {                                                                      │  ║
║  │   "orders": [                                                          │  ║
║  │     {                                                                  │  ║
║  │       "track_number": "TRACK-123",                                     │  ║
║  │       "external_id": "ORDER-TEEZ-001",                                 │  ║
║  │       "status": "with_courier|delivered|not_delivered|...",            │  ║
║  │       "status_reason": "customer_not_available",                       │  ║
║  │       "status_datetime": "2025-04-15T14:30:00Z",                      │  ║
║  │       "delivery_datetime": "2025-04-15T14:30:00Z",                    │  ║
║  │       "photo_url": "https://s3.coube.kz/photos/123.jpg",              │  ║
║  │       "receiver_name": "Иван Иванов",                                  │  ║
║  │       "receiver_phone": "+77123456789",                                │  ║
║  │       "delivery_address": "г. Астана, ул. Пушкина 1",                 │  ║
║  │       "courier_comment": "Клиент не ответил",                          │  ║
║  │       "positions": [...]                                               │  ║
║  │     }                                                                  │  ║
║  │   ],                                                                   │  ║
║  │   "not_found": ["TRACK-999"]                                           │  ║
║  │ }                                                                      │  ║
║  │                                                                        │  ║
║  │ 🔄 TEEZ делает polling каждые 5-10 минут                              │  ║
║  │ 📊 Rate Limit: 60 req/min, 1000 req/hour                              │  ║
║  │ 📦 Max: 100 track_numbers за запрос                                   │  ║
║  └────────────────────────────────────────────────────────────────────────┘  ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

## Статусы заказов

```
                    ┌─────────────┐
                    │   Создан    │ (загружен из TEEZ_PVZ)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  Назначен   │ (логист назначил курьера)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  В работе   │ (курьер принял заявку)
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   В пути    │ ("начать путь")
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │with_courier │ ◄─ TEEZ: "Заказ у курьера"
                    │(у курьера)  │
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┬──────────────┐
         │                 │                 │              │
    ┌────▼─────┐    ┌──────▼──────┐    ┌────▼────┐   ┌────▼────────┐
    │delivered │    │not_delivered│    │returned │   │courier_     │
    │(доставлен│    │(не доставлен│    │(возврат)│   │cancelled    │
    │+ SMS код)│    │+ причина)   │    │         │   │(не доехал)  │
    └──────────┘    └─────┬───────┘    └─────────┘   └─────────────┘
         │                │
         │          ┌─────▼──────┐
         │          │Причины:    │
         │          │• customer_ │
         │          │  not_avail │
         │          │• customer_ │
         │          │  refused   │
         │          │• address_  │
         │          │  not_found │
         │          └─────┬──────┘
         │                │
         │          ┌─────▼──────┐
         │          │returned_to │ ◄─ TEEZ: "Возвращено
         └──────────┤_sender     │         отправителю"
                    │(на складе) │
                    └────────────┘

╔═══════════════════════════════════════════════════════════════╗
║           Маппинг статусов Coube ↔ TEEZ                      ║
╠═══════════════════════════════════════════════════════════════╣
║  1. with_courier      → "Заказ у курьера"                     ║
║  2. delivered         → "Доставлено курьером"                 ║
║  3. not_delivered     → "Курьер не смог доставить" + причина  ║
║  4. returned_to_sender→ "Возвращено отправителю"              ║
╚═══════════════════════════════════════════════════════════════╝
```

## Структура данных (упрощенная)

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  WAYBILL        │────▶│     ORDER       │────▶│    ADDRESS      │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ id              │     │ id              │
│ external_id     │     │ external_id     │     │ full_address    │
│ created_date    │     │ barcode         │     │ latitude        │
│ status          │     │ status          │     │ longitude       │
│ courier_id      │     │ delivery_time   │     │ is_problematic  │
└─────────────────┘     │ verification    │     └─────────────────┘
                        └─────────────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    COURIER      │     │    GEOZONE      │     │INTEGRATION_LOG  │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id              │     │ id              │     │ object_id       │
│ external_teez_id│     │ name            │     │ event_type      │
│ full_name       │     │ coordinates     │     │ success         │
│ phone           │     └─────────────────┘     │ error_message   │
│ active          │                             │ created_at      │
│ current_status  │                             └─────────────────┘
└─────────────────┘
```

## Pull-модель: Получение статусов TEEZ

```
     COUBE завершает маршрут
              │
              ▼
    ┌─────────────────────┐
    │  Маршрут завершен   │
    │  Статусы готовы     │
    │  в базе данных      │
    └─────────────────────┘
              │
              │ ◄────────────────────┐
              │                      │
              │                      │
    ┌─────────▼─────────┐  ┌─────────────────┐
    │  TEEZ делает      │  │ Polling сервис  │
    │  GET запрос       │  │ TEEZ запускает  │
    │  каждые 5-10 мин  │  │ периодически    │
    └─────────┬─────────┘  └─────────────────┘
              │
              ▼
    ┌─────────────────────────────────────────┐
    │ GET /api/v1/integration/courier/        │
    │     orders/status                       │
    │     ?track_numbers=TRACK1,TRACK2,...    │
    │                                         │
    │ X-API-Key: {teez-api-key}              │
    └─────────┬───────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │ Response:           │
    │ {                   │
    │   "orders": [       │
    │     {               │
    │       "status":     │
    │         "delivered" │
    │     }               │
    │   ]                 │
    │ }                   │
    └─────────┬───────────┘
              │
    ┌─────────▼─────────┐
    │ TEEZ обрабатывает │
    │ статусы в своей   │
    │ системе           │
    └───────────────────┘
              │
    ┌─────────▼─────────┐
    │ Rate Limit:       │
    │ 60 req/min        │
    │ 1000 req/hour     │
    └───────────────────┘

╔════════════════════════════════════════════════════╗
║  🔄 Polling Model Advantages:                     ║
║  ✅ TEEZ контролирует частоту запросов            ║
║  ✅ Нет async queue на стороне Coube              ║
║  ✅ Нет retry механизма на стороне Coube          ║
║  ✅ TEEZ управляет retry-логикой сам              ║
║  ✅ Упрощает масштабирование                      ║
╚════════════════════════════════════════════════════╝
```

---

## 🚀 Что нужно реализовать:

**Высокий приоритет:**
- [x] API интеграции с TEEZ_PVZ (входящий): POST /api/v1/integration/waybills
- [ ] API для получения статусов (для TEEZ): GET /api/v1/integration/courier/orders/status
  - Поддержка до 100 track_numbers за запрос
  - Rate limiting: 60 req/min, 1000 req/hour
  - Маппинг 4 статусов для TEEZ
- [ ] Новые справочники (курьеры, склады, статусы)
- [ ] Логирование интеграционных событий
- [ ] Database index для track_number + source_system

**Средний приоритет:**
- [ ] Расширение Driver API (SMS, сканы, возвраты)
- [ ] Валидации и бизнес-логика маршрутов
- [ ] Пометка проблемных адресов
- [ ] Реализация статуса `returned_to_sender`

**Низкий приоритет:**
- [ ] Аналитические отчеты
- [ ] Web интерфейс для логистов
- [ ] Excel выгрузки
- [ ] Опциональный webhook notification (вместо polling)

---

## 📝 История изменений

**16.10.2025** - Обновление интеграции с TEEZ:
- ❌ Убрали Push-модель (POST результатов в TEEZ)
- ❌ Убрали PUB/SUB систему для асинхронной отправки
- ✅ Добавили Pull-модель (TEEZ запрашивает статусы)
- ✅ Новый endpoint: GET /api/v1/integration/courier/orders/status
- ✅ Polling каждые 5-10 минут по track_numbers
- ✅ 4 статуса для TEEZ: with_courier, delivered, not_delivered, returned_to_sender
- ✅ Rate limiting: 60 req/min, 1000 req/hour

---
*ASCII диаграммы совместимы с любыми текстовыми редакторами и системами*