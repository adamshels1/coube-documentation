**ТЗ на изменение утвержденных заявок**

Оглавление

[ТЗ №1 (ВСПОМОГАТЕЛЬНОЕ). Подготовка БД
1](#тз-1-вспомогательное.-подготовка-бд)

[ТЗ №2. ШАБЛОНЫ ЭКИПАЖА (Автопарк) 7](#тз-2.-шаблоны-экипажа-автопарк)

[ТЗ №3. КОМПОНОВКА ФАКТИЧЕСКОГО "ЭКИПАЖА" ПОЕЗДКИ
8](#тз-3.-компоновка-фактического-экипажа-поездки)

[ТЗ №4. ИЗМЕНЕНИЕ "СУЩЕСТВЕННЫХ" УСЛОВИЙ ЗАЯВКИ (маршрута)
11](#тз-4.-изменение-существенных-условий-заявки-маршрута)

[4.1. Браузер для логиста заказчика: 11](#браузер-для-логиста-заказчика)

[4.2. Браузер для логиста исполнителя:
15](#браузер-для-логиста-исполнителя)

[4.3. Мобильное приложение: 16](#мобильное-приложение)

[ТЗ №5. КОРРЕКТИРОВКА В "АДМИНКЕ СИСТЕМЫ" ДАННЫХ О ДВИЖЕНИИ ВОДИТЕЛЯ
17](#тз-5.-корректировка-в-админке-системы-данных-о-движении-водителя)

#  {#section .unnumbered}

# ТЗ №1 (ВСПОМОГАТЕЛЬНОЕ). Подготовка БД 

1.  В таблице основной информации о заявках должны быть поля:

    -   БИН/ИИН компании-заказчика

    -   Ответственный сотрудник (логист) со стороны заказчика. По
        умолчанию заполняется тем, который создал эту заявку.

    -   БИН/ИИН исполнителя

    -   Ответственный сотрудник (логист) со стороны исполнителя. Как
        будет определяться -- можно узнать у Тофика

2.  Для каждой заявки/перевозки должны быть *[напрямую]{.underline}*
    записаны следующие данные (это ее экипаж):

    -   Список водителей

        -   Идентификатор водителя

        -   Признак "Заменен в пути"

        -   Флажок "является ли основным водителем в этой поездке на
            данный момент?"

    -   Список компонентов транспортных средств

        -   Идентификатор компонента

        -   Признак "Заменен в пути".

        -   Тип компонента ( "голова", "кузов" и т.д.)

    -   Все эти данные не должны вычисляться через промежуточные связи!
        Их должен заполнить на фронтэнде пользователь, и они напрямую
        связываются с заявкой.

3.  Таблица связи между машины и водителем: должна быть переделана в
    таблицу [Шаблонов Экипажей]{.underline}. Эта таблица должна быть
    справочной (шаблоном)! Не путать шаблон экипажа с фактическим
    экипажем. Фактический экипаж привязан напрямую к заявке, а здесь
    просто шаблон.

4.  В **Таблицу истории действий по поездке** нужно добавить все типы
    информаций о действиях юзеров внутри поездке, в том числе о переходе
    флажка "основого" водителя от одного юзера к другому

5.  Необходимо создать **Таблицу(ы) изменений (корректировок)
    согласованных заявок**

    -   Идентификатор заявки

    -   Идентификатор запущенного процесса изменения

    -   Текущий статус (Сохранено заказчиком как черновик / Прекращено
        заказчиком до подписания / Подписано заказчиком / Отменено
        заказчиком после подписания / Отклонено исполнителем /
        Утверждено)

6.  **Таблица истории (лог) действий по изменению заявок**

    -   Ссылка на идентификатор заявки

    -   Ссылка на идентификатор запущенного процесса изменения

    -   Идентифкатор события (действия)

    -   Пользователь, совершивший действие

    -   Дата совершения действия

    -   Тип действия (Сохранение / Подписание документа / Отказ в
        подписании / Отозвана ранее подписанная подпись)

7.  Необходимо создать **таблицу/лог "Сравнение маршрута"**. В ней
    должна храниться *[вся история]{.underline}* изменений маршрутов.
    Рекомендуется использовать для этого не отдельную табилцу, а хранить
    эти данные в файловых массивах.

    -   Идентификатор изменения

    -   Ссылка на идентификатор *Таблицы изменений*

    -   Ссылка на идентификатор *Таблицы истории изменений*, в рамках
        которого это Савнение маршрутов было создано/пересохранено

    -   Идентификатор точки маршрута до изменения

    -   Порядковый номер точки внутри маршрута до изменения

    -   Координаты точки маршрута до изменения

    -   Тип изменения (доступные значения: "Осталась" / "Удалена" /
        "Добавлена" / "Изменен адрес")

    -   Новый идентификатор точки маршрута (если точка не была удалена)

    -   Новые порядковый номер точки внутри маршрута

    -   Новые координаты

8.  В **таблицу ХМЛ/ПДФ файлов** (file-meta-info) необходимо добавить
    поля:

    -   Тип документа (возможные значения: заявка-приложение к договору
        основная / договор / заявка-договор / корректировочная заявка)

    -   Ссылка на идентификатор изменения в Таблице изменений (на данный
        момент это поле заполняется только для корректировочных заявок)

9.  В **Основной таблице маршрутов**, для всех точек маршрута добавить
    новый столбец "Изменения". Возможные значения:

    -   "Черновые/на согласовании"

    -   "Утвердженные" (так отмечаются все точки маршрута, когда они
        утверждены двусторонним подписанием)

    -   "Более не актуальные" (так помечаются все точки маршрута, ранее
        бывшие в статусе Утвержденные, но затем отмененные).

    -   "Изменен адрес" (так помечаются точки, для которых был изменен
        адрес).

    -   Все это нужно для того, чтобы не стирать точки из маршрута!
        Несмотря на то, что основная история версий маршрутов будет
        храниться в отдельной таблице **[Сравнения
        Маршрутов]{.underline}** -- есть риск, что стирать данные из
        Основной Таблицы Маршрутов во многих случаях небезопасно
        (поскольку с ними связаны другие табилцы). Для решения этой
        ситуации, предложены такие статусы.

*[Таблица 1 Процесс движения данных на бэкенде при изменении
"существенных" условий заявки (Маршрутов)]{.underline}*

+------------------------+---------------------------------------------+
| **Событие в системе**  | **Бэкенд**                                  |
+------------------------+---------------------------------------------+
| *(Впервые в БД         | -   В Основной таблице маршрутов:           |
| создается маршрут, в   |                                             |
| рамках заявки, которая |     -   Точки создаются в статусе           |
| еще не утверждена)*    |         "Черновик" (или пустой статус)      |
+------------------------+---------------------------------------------+
| Заявка подписана       | -   В Основной таблице маршрутов:           |
| обеими сторонами       |                                             |
| (заказчиком и          |     -   Все точки маршрута переводятся в    |
| исполнителем)          |         статус "Утверждены"                 |
+------------------------+---------------------------------------------+
| Логист заказчика       | Ничего не происходит                        |
| создает корректировку, |                                             |
| не сохраняя ее         |                                             |
+------------------------+---------------------------------------------+
| Логист заказчика       | -   В Таблице процессов изменений:          |
| впервые сохраняет      |                                             |
| новый маршрут в        |     -   Создается новый идентификатор       |
| черновик, но не        |         процесса                            |
| подписывает изменение  |                                             |
| по ЭЦП                 |     -   Статус процесса = "Черновик"        |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Сохранен    |
|                        |         черновик"                           |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Создается новый маршрут и его       |
|                        |         сравнение с первоначально           |
|                        |         утвержденным                        |
|                        |                                             |
|                        |     -   Этот маршрут связывается с заявкой  |
|                        |         и с процессом ее изменения.         |
+------------------------+---------------------------------------------+
| Логист заказчика       | -   В Таблице процессов изменений:          |
| заходит в сохраненный  |                                             |
| черновой маршрут и     |     -   Статус процесса остается прежним    |
| редактирует его (снова |         "Черновик"                          |
| сохраняет, но не       |                                             |
| подписывает)           | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Сохранен    |
|                        |         черновик" / ид пользователя /       |
|                        |         дата-время                          |
|                        |                                             |
|                        | -   Если вдруг по этому -- они удаляются    |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Пересохраняется новый маршрут и его |
|                        |         сравнение с тем, который был        |
|                        |         последним утвержден                 |
+------------------------+---------------------------------------------+
| Логист заказчика       | -   В Таблице процессов изменений:          |
| заходит в сохраненный  |                                             |
| черновой маршрут и     |     -   Статус процесса меняется на         |
| стирает его            |         "Прекращено заказчиком до           |
|                        |         подписания"                         |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Заказчик    |
|                        |         отменил до подписания" / ид         |
|                        |         пользователя / дата-время           |
|                        |                                             |
|                        | -   Если вдруг по этому процессу изменений  |
|                        |     были документы ХМЛ/ПДФ -- они удаляются |
|                        |                                             |
|                        | -   Из таблицы "Сравнение маршрутов":       |
|                        |                                             |
|                        |     -   Запись удаляется или ничего не      |
|                        |         происходит (рекомендуется не        |
|                        |         удалять, на всякий случай)          |
+------------------------+---------------------------------------------+
| Логист заказчика       | -   В Таблице ХМЛ/ПДФ документов:           |
| впервые отправляет     |                                             |
| изменение на           |     -   Создается новый документ ХМЛ/ПДФ    |
| подписание             |                                             |
|                        |     -   Тип документа = "Корректировочная   |
|                        |         заявка".                            |
|                        |                                             |
|                        |     -   Статус документа = "Подписан        |
|                        |         заказчиком, ожидает подписания      |
|                        |         исполнителем"                       |
|                        |                                             |
|                        | -   В Таблице процессов изменений:          |
|                        |                                             |
|                        |     -   Статус процесса меняется на "На     |
|                        |         согласовании"                       |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Заказчик    |
|                        |         подписал"                           |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Ничего не меняется, сравнение       |
|                        |         остается                            |
+------------------------+---------------------------------------------+
| Логист заказчика       | -   В Таблице ХМЛ/ПДФ документов:           |
| отменяет подписанное   |                                             |
| изменение (до того,    |     -   Статус документа ХМЛ / ПДФ          |
| как Исполнитель успел  |         "Корректировочная заявка" меняется  |
| подписать)             |         на соответствующий                  |
|                        |                                             |
|                        | -   В Таблице процессов изменений:          |
|                        |                                             |
|                        |     -   Статус процесса меняется на         |
|                        |         "Отменено заказчиком"               |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Отозвана    |
|                        |         подпись"                            |
|                        |                                             |
|                        | -   Исполнитель больше не может подписывать |
|                        |     эту корректировку.                      |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Ничего не меняется, сравнение       |
|                        |         остается                            |
|                        |                                             |
|                        | В МВП, вернуть это изменение уже будет      |
|                        | нельзя. Оно сохранится для истории, больше  |
|                        | с ним никаких изменений не происходит.      |
+------------------------+---------------------------------------------+
| Логист исполнителя     | В целом аналогично предыдущему пункту:      |
| отклоняет подписание   |                                             |
|                        | -   В Таблице ХМЛ/ПДФ документов:           |
|                        |                                             |
|                        |     -   Статус документа ХМЛ / ПДФ          |
|                        |         "Корректировочная заявка" меняется  |
|                        |         на соответствующий                  |
|                        |                                             |
|                        | -   В Таблице процессов изменений:          |
|                        |                                             |
|                        |     -   Статус процесса меняется на         |
|                        |         "Отклонено исполнителем"            |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Отказано в  |
|                        |         подписании"                         |
|                        |                                             |
|                        | -   Исполнитель больше не может подписывать |
|                        |     эту корректировку.                      |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Ничего не меняется, сравнение       |
|                        |         остается                            |
|                        |                                             |
|                        | В МВП вернуть это изменение уже будет       |
|                        | нельзя. Оно сохранится для истории, больше  |
|                        | с ним никаких изменений не происходит.      |
+------------------------+---------------------------------------------+
| Логист исполнителя     | -   В Таблице ХМЛ/ПДФ документов:           |
| подписывает            |                                             |
|                        |     -   Статус документа ХМЛ / ПДФ          |
|                        |         "Корректировочная заявка" меняется  |
|                        |         на соответствующий                  |
|                        |                                             |
|                        | -   В Таблице процессов изменений:          |
|                        |                                             |
|                        |     -   Статус процесса меняется на         |
|                        |         "Утверджено"                        |
|                        |                                             |
|                        | -   В Таблице (логе) истории изменений      |
|                        |                                             |
|                        |     -   Создается новая запись "Подписано"  |
|                        |                                             |
|                        | -   В таблице "Сравнение маршрутов":        |
|                        |                                             |
|                        |     -   Ничего не меняется.                 |
|                        |                                             |
|                        | -   В Основной таблице маршрутов:           |
|                        |                                             |
|                        |     -   Те точки маршрута, которые были     |
|                        |         удалены, переводятся в статус       |
|                        |         "Более не актуальные".              |
|                        |                                             |
|                        |     -   Те точки маршрута, которые были     |
|                        |         добавлены -- добавляются со         |
|                        |         статусом "Актуальные"               |
|                        |                                             |
|                        |     -   Те точки маршрута, которые были     |
|                        |         изменены -- перезаписываются; при   |
|                        |         этом для них меняется статус на     |
|                        |         "Адрес изменен"                     |
+------------------------+---------------------------------------------+

# ТЗ №2. ШАБЛОНЫ ЭКИПАЖА (Автопарк)

**Браузер исполнителя**

Для каждой организации-исполнителя есть экранные формы:

-   Список транспортных средств и их компонентов ("головы", "прицепы" и
    т.д. - это уже есть).

-   Создание нового компонента средства:

    -   Тип компонента (например "голова")

    -   Кастомное название

    -   Номера

    -   Прочие параметры; предполагается, что это тоже уже есть.

-   Создание шаблона компоновки. Шаблон компоновки представляет собой
    некое транспортное средство, собранное из разных компонентов +
    водитель, который на нем обычно ездит. Можно назвать это "Шаблоны
    транспортных средств" или "Шаблон экипажа". Название уточнить при
    отрисовке с Тофиком

    -   Ввести название шаблона

    -   Выбрать водителя

    -   Выбрать голову

    -   Выбрать остальные компоненты (прицеп/кузов)

    -   Подробно разные примеры шаблона компоновки уточнить при
        отрисовке с Тофиком

    -   Признак "шаблон актуален / шаблон неактуален"

    -   Сохранить шаблон.

Когда пользователь редактирует шаблон -- в тех поездках, в которых этот
шаблон был использован, ничего не изменяется!

# ТЗ №3. КОМПОНОВКА ФАКТИЧЕСКОГО "ЭКИПАЖА" ПОЕЗДКИ

**Браузер исполнителя: Компоновка из шаблона транспортного средства**

Когда заявка поступает логисту исполнителя, он формирует экипаж путем
подбора водителя / "головы" Транспортного Средства / кузова и т.д.

Предлагается такой сценарий:

-   Логист исполнителя выбирает Шаблон компоновки транспортного
    средства.

-   Из Шаблона автоматически подтягивается весь набор компонентов.

-   Далее логист может отредактировать состав транспортного средства
    вручную (подобрать новые компоненты/убрать какие-то из
    существующих). [Примечание]{.underline}: обычно логист не будет
    ничего редактировать и будет полагаться на шаблон, но возможность
    редактирования необходима для исключительных ситуаций.

После того, как из шаблона подтянулись компоненты в поездку/заявку,
далее никаких автоматических изменений в компонентах перевозки быть не
может! Дальнейшие изменения вносит только логист.

**Браузер исполнителя: Подбор водителей**

-   Водитель предлагается по умолчанию тот, что в шаблоне, но логист
    должен [дополнительно]{.underline} его подтвердить.

-   Логист исполнителя может подключить несколько водителей к поездке.
    ДО ДВУХ. Один из них основной. Второй вспомогательный.

    -   Заявка улетает сначала осноному водителю; Он должен принять или
        отказаться.

    -   Вспомогательному водителю приходит уведомление, но он не может
        ни принять ни отказаться до тех пор пока Главный водитель не
        принял? Подумать при разработке дизайна.

-   Когда логист приглашает водителя в поездку, у него отображается
    тумблер "Основной водитель / дополнительный водитель".

-   При подтягивании водителя в поездку, если у поездки еще нет
    основного водителя, он по умолчанию предлагается как основной.

-   Если у поездки есть основной водитель, все остальные водители по
    умолчанию предлагаются к подтягиванию как дополнительные

-   Логист может всегда видеть список всех водителей, выбранных на
    поездку. Основной водитель ярко выделен в списке.

-   В любой момент поездки логист может менять, кто является Основным
    водителем. При этом логисту выводится уведомление: "ВНИМАНИЕ! Только
    этот водитель сможет управлять поездкой! Все остальные водители
    переведутся в режим просмотра. GPS-сигнал также будет отслеживаться
    с этого водителя. Вы уверены?"

-   Основной водитель предлагается по умолчанию тот, что в шаблоне, но
    логист должен [дополнительно]{.underline} его подтвердить.

-   Если водитель отклоняет свое участие в поездке, автоматически
    выбирается другой основной водитель:

    -   если в поездке нет ни одного водителя, который подтвердил
        уччастие -- рандомный из оставшихся водителей становится
        основным;

    -   если в поездке есть только один водитель, который подтвердил
        свое участие -- он становится основным;

    -   если в поездке есть несколько водителей, подтвердивших участие
        -- проверяется, отправлял ли до этого кто-то из них действия
        (кроме действия "Подтвердить свое участие") в этой поездке
        (например, отмечал, что приехал/уехал с какой-нибудь точки):

        -   Если такой водитель был только один, он становится основным.

        -   Если таких водителей больше одного, то рандомный из них
            становится основным

-   Если поездка уже началась, то логист может сделать замену водителя
    и/или "головы" машины. Замененные компоненты должны сохраниться с
    каким-нибудь признаком (о том, что их участие прекращено), а новые
    компоненты должны быть выделены как добавленные заново.

-   О любом изменении водителя/компонента транспортного средства
    Заказчику должно приходить уведомление.

-   О любой смене основного водителя Заказчику также должно приходить
    уведомление.

**Моб приложение**

1\. Водитель всегда видит всех водителей, которые подключены к
перевозке. Видит как минимум их :

-   имя,

-   контактные данные;

```{=html}
<!-- -->
```
-   информацию о том, приняли они поездку или их подтверждение
    ожидается.

Также водитель видит компоненты автотранспорта, которые прикреплены к
поездке.

2\. Водители, которые не являются Основными, если они подтвердили свое
участие и не Выбыли из поездки -- по умолчанию видят все то же самое,
что основной водитель в приложении. Здесь необходимо решить на уровне
архитектуры, как возможно обеспечить синхронное обновление страниц для
всех водителей, когда у основного пользователя что-либо меняется
(например, он нажал кнопку -- перешел на следующий экран -- по-хорошему
все вспомогательные пользователи тоже должны быть переведены на этот
новый экран?).

Основной пользователь может нажимать кнопки "Прибыл" / "Убыл" / "Начал
движение" и т.д. внутри поездки. (кроме случая в п.3)

3\. **[Все]{.underline}** водители могут нажимать кнопку СОС!

Даже выбывшие (например, выбывшие час назад)!

4\. Трекинг ведется с устройства основного водителя в каждый момент
времени.

# ТЗ №4. ИЗМЕНЕНИЕ "СУЩЕСТВЕННЫХ" УСЛОВИЙ ЗАЯВКИ (маршрута)

На данный момент "существенные" изменения вносить в систему может только
логист Заказчика.

Существенными пока что считаем только изменение маршрута. Остальные
изменения либо запрещены, либо не требуют переподписания по ЭЦП.

## 4.1. Браузер для логиста заказчика:

**4.1.1. Начало изменения условий подписанной заявки**

Логист заказчика заходит в Заявку, которая уже подписана всеми
сторонами.

На такой заявке выведена кнопка "[Изменить условия подписанной
заявки]{.underline}" (окончательное название выбрать при отрисовке с
Тофиком).

Если эту кнопку нажал не тот логист, чья это заявка -- выводится
предупреджение: "Это не ваша заявка! Ответственный логист (Имя логиста).
Вы точно уверены, что желаете отредактировать чужую заявку?" Кнопки:

• Да, хочу отредактировать хотя это чужая заявка

• Не хочу

После нажатия, пользователь попадает в режим изменения маршрута.

**4.1.2. Режим изменения маршрута**

Для пользователя стова становится доступным редактирование маршрута.
Пользователь:

1\. видит первоначальный маршрут

2\. может интерактивно его корректировать.

2.1. Напротив любой точки машрута -- кнопка "изменить" ее (поменять
адрес)

2.2. Напротив любой точки маршрута -- кнопка "удалить" точку

2.3. Между любыми точками -- добавить новую

Визуальная отработка:

1\. Если логист удаляет точку: Точка остается видна на экране, но
выделена как неактивная, и на точке есть пометка о том, что она удалена.

2\. Если логист добавляет новую точку: Новая точка появляется на экране,
при этом она выделена с явной пометкой о том, что она была добавлена.

3\. Если логист изменяет точку: На экране остается прежний адрес,
выделен как неактивный, указано, что он изменен, и рядом указан новый
адрес (выделен как примененный после изменения)

4\. Продолжают работать все стандартные валидации для маршрутов: В
частности, маршрут должен состоять вначале из точек погрузки, затем из
точек разгрузки. В маршруте не может встречаться поочередная цепочка
"Погрузка -- Разгрузка -- Погрузка".

**4.1.3. Сохранение внесенных изменений**

1\. В режиме редактирования маршрута, у водителя есть три кнопки:

-   Отменить

-   Сохранить изменения маршрута (как черновик)

-   Подтвердить (подтвердить изменение и перейти к подписанию)

2\. При нажатии кнопки Отменить, никакая информация о попытках изменения
заявки не записывается в БД.

3\. При нажатии кнопки Сохранить:

-   в БД записывается информация о том, что запущен процесс
    корректировки заявки; и тип процесса корректировки (корректировка
    маршрута);

-   в БД записывается черновой маршрут (или черновая версия новых
    параметров машины) в статусе НЕАКТИВНО;

4\. При нажатии кнопки Подтвердить и подписать:

-   в БД записывается информация о том, что запущен процесс
    корректировки заявки; и тип процесса корректировки (корректировка
    маршрута);

-   в БД записывается черновой маршрут (или черновая версия новых
    параметров машины) в статусе НЕАКТИВНО;

-   Создается корректировочная заявка ХМЛ/ПДФ для подписания
    пользователем, пользователь подписывает, документ считается
    подписанной заказчиком и отправляется на подпись Исполнителю.

**4.1.4. Продолжение работы с сохраненным, но не подписанным
изменением**

Если логист начал процесс изменения заявки, сохранил изменение в
черновике, но не подписал по каким-то причинам -- он сможет вернуться к
редактированию изменений в будущем.

Для этого, при откытии заявки, на главной странице Заявки выводятся:

-   1\. Если был запущен процесс изменения маршрута + Сохранен черновой
    маршрут + Изменения пока не подписаны Заказчиком:

    -   Наверху сообщение о том, что по данной заявке был запущен
        процесс изменений

    -   Если, кроме того, по заявке уже были ранее успешно утвержденные
        двумя сторонами другие корректировки, то выводится рядом еще
        одно сообщение: *"Кроме того, ранее заявка уже
        корректировалась (1) раз с согласия сторон!".* Сообщение
        кликабельное, по нему можно перейти к просмотру истории
        изменений

    -   Сама заявка открывается для в режиме сравнения (до изменений --
        после изменений)

    -   В самой заявке, пользователь может продолжить редактирование
        изменений.

    -   Пользователь может отменить все изменения.

-   2\. Если был запущен процесс изменения маршрута, Изменения подписаны
    Заказчиком и ожидают подписания Исполнителем:

    -   Заявка отображается в режиме сравнения изменений.

    -   Вверху заявки сообщение "Внесенные изменения отправлены
        исполнителю \[Дата отправки исполнителю\]!"

    -   Если, кроме того, по заявке уже были ранее успешно утвержденные
        двумя сторонами другие корректировки, то выводится рядом еще
        одно сообщение: *"Кроме того, ранее заявка уже корректировалась
        \[(n)\] раз с согласия сторон!".*

    -   На оба этих сообщения одна и та же кликабельная ссылка, где
        можно посмотреть историю изменений с подробностями.

    -   Инициировать новые изменения нельзя

-   3\. Если последние изменения подписаны и Заказчиком, и Исполнителем:

    -   *(Дополнительное требование, может выходить за рамки МВП)*
        Первые несколько часов заявка отображается в режиме сравнения
        старого и нового маршрута:

        -   Наверху заявки большое сообщение о том, что было успешное
            изменение условий

        -   Пользователь может перейти и посмотреть на все подробности
            изменений (сравнение старого маршрута с новым, история
            кто/когда подписал изменения)

        -   Можно инициировать новые изменения.

            -   При попытке инициировать новые изменения, пользователю
                выводится уведомление "Недавно (дата-время подписания
                Исполнителем) были утверждены новые условия. Уверены ли
                вы, что хотите снова пересогласовать условия Заявки?"

            -   Если пользователь соглашается, инициирует следующие
                изменения и сохраняет их (в черновике или отправляет на
                подписание) -- то при следующем открытии карточки Заявки
                по умолчанию открывается уже новый режим сравнения.

    -   После этого:

        -   Заявка открывается и отображается уже со всеми новыми
            значениями.

        -   Наверху заявки большое сообщение "Заявка корректировалась
            \[(n)\] раз по согласованию сторон!" Посмотреть детали
            (кликабельная ссылка). По ссылке открывается история
            изменений. Для каждого изменения можно провалиться в
            подробности и посмотреть сравнение нового маршрута со старым
            / историю подписания и прочие подробности.

        -   Можно инициировать новые изменения

-   4\. Если последний процесс внесения изменений был утвержден
    Заказчиком, но отклонен Исполнителем:

    -   На заявке выводится информация о том, что была попытка внести
        изменения, но Исполнитель отклонил их.

    -   Пользователь может перейти к просмотру этих изменений (увидев и
        новые, и старые значения).

    -   Пользователь может посмотреть документы ХМЛ/ПДФ, подписание
        которых было отклонено.

    -   Можно инициировать новые процессы изменений.

**4.1.5. Отмена подписанных изменений Заказчиком**

Предлагается не делать эту фичу в МВП.

Заказчик может отменить изменения в любой момент, пока Исполнитель их не
подписал.

Исполнителю отправляется уведомление об этом.

У Исполнителя с этого момента новые изменения становятся недоступны для
подписания.

Исполнитель продолжает видеть изменения, с большим примечанием о том,
что Заказчик отменил их (с указанием даты-времени, когда Заказчик
отменил).

Заказчик видит заявку в том же виде, в котором она была до внесения
изменений. Вверху выводится сообщение "Процесс внесения изменений в
заявку отменен Заказчиком (дата-время отмены)".

## 4.2. Браузер для логиста исполнителя:

При откытии заявки, на главной странице Заявки выводятся:

-   1\. Если последний процесс изменения ([не считая
    черновиков]{.underline}) находится в статусе "Отказано в подписании
    исполнителем"

    -   Заявка отображается как обычно.

    -   Сверху отображается "Исполнителем отклонены изменения в заявке
        (дата отклонения".

    -   Если, кроме того, по заявке уже были ранее успешно утвержденные
        двумя сторонами другие корректировки, то выводится рядом еще
        одно сообщение: *"Кроме того, ранее заявка уже
        корректировалась (1) раз с согласия сторон!".*

    -   Пользователь может открыть изменения по ссылкам и посмотреть
        подробности.

-   2\. Если последний процесс изменения ([не считая
    черновиков]{.underline}) находится в статусе "Подписано заказчиком,
    ожидает подписания исполнителем"

    -   Заявка отображается в режиме изменения. Пользователь сразу видит
        изменения.

    -   Сверху отображается "Заказчик внес изменения в заявку! (Дата
        подписания заказчиком)".

    -   Отображается интерактивная кнопка ПОДПИСАТЬ ИЗМЕНЕНИЯ.
        Окончательный дизайн кнопки согласовать с Тофиком при отрисовке

    -   Если, кроме того, по заявке уже были ранее успешно утвержденные
        двумя сторонами другие корректировки, то выводится рядом еще
        одно сообщение: *"Кроме того, ранее заявка уже
        корректировалась (1) раз с согласия сторон!".* Сообщение с
        кликабельной ссылкой, по ней открывается полная история всех
        изменений. Во все из них можно провалитьсяя и посмотреть
        подробности.

-   3\. Если последний процесс изменения ([не считая
    черновиков]{.underline}) находится в статусе "Отозвано заказчиком
    после подписания"

    -   Заявка отображается как обычно.

    -   Сверху отображается "Заказчик внес изменения в заявку, но
        ОТОЗВАЛ их! (Дата, когда заказчик отозвал)". Гиперссылка, по
        которой можно посмотреть подробности.

    -   Если, кроме того, по заявке уже были ранее успешно утвержденные
        двумя сторонами другие корректировки, то выводится рядом еще
        одно сообщение: *"Кроме того, ранее заявка уже
        корректировалась (1) раз с согласия сторон!".* Сообщение с
        кликабельной ссылкой, по ней открывается полная история всех
        изменений. Во все из них можно провалитьсяя и посмотреть
        подробности.

-   5\. В остальных случаях -- **обычное отображение заявки**:

    -   Заявка открывается и отображается с последними актуальными
        (утвержденными двумя сторонами) значениями.

    -   Если по заявке была хотя бы одна успешная корректировка:

        -   Наверху заявки большое сообщение "Заявка корректировалась
            \[(n)\] раз по согласованию сторон!" Посмотреть детали
            (кликабельная ссылка). По ссылке открывается история
            ***ВСЕХ*** изменений. Для каждого изменения можно
            провалиться в подробности и посмотреть сравнение нового
            маршрута со старым / историю подписания и прочие
            подробности.

## 4.3. Мобильное приложение:

**Обсудить: Уведомление водителя о *[планируемом]{.underline}* изменении
условий заявки (маршрута)**

Когда Заказчик подписал изменения в маршрут -- водителю приходит
уведомление, что машрут собираются изменить.

**Уведомление водителя об *[утвержденном]{.underline}* изменении условий
заявки (маршрута)**

После подписания изменений Исполнителем:

1\. Водителю автоматически приходит уведомление об изменении условий
маршрута.

-   Исключение: если водитель находится в режиме "СОС", уведомление о
    смене маршрута придет ему после того, как он выйдет из режима СОС.

2\. Водителю сразу выводится новый маршрут в режиме сравнения со старым.

3\. Водитель продолжает ехать уже по новому маршруту.

4\. Изменений может быть множество, водитель может видеть всю историю
изменений маршрутов.

Также водителю должна отображаться дата утверждения новых условий (дата
подписания Исполнителем).

# ТЗ №5. КОРРЕКТИРОВКА В "АДМИНКЕ СИСТЕМЫ" ДАННЫХ О ДВИЖЕНИИ ВОДИТЕЛЯ

**Браузер -- админка системы**

Логист исполнителя всегда видит историю событий по поездкам.

"Админ системы" всегда видит историю событий по поездкам.

Админ в непредвиденных случаях -- на основе сообщения в техподдержку --
может вручную скорректировать информацию о том, где сейчас находится
водитель:

-   находится ли он на какой-либо конкретной точке (погрузки/разгрузки)

-   или он покинул какую-то из точек и сейчас направляется к следующей

Пока что, в МВП, эта возможность доступна после статуса "Начать
движение" и перед статусом "Поездка завершена".

**Мобильное приложение**

Водителям приходит уведомление "Ваше перемещение было скорректировано
заказчиком!" Кнопка Обновить.

Скипнуть нельзя. Водитель обязан нажать эту кнопку, чтобы продолжить
работу.

Это уведомление не приходит в режиме "СОС" (придет после того, как
водитель выйдет из этого режима).
