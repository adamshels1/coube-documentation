**Проект продукта: курьерская доставка**

**Содержание**

[I. Внутренние дополнительные структуры данных , которые будут
использоваться в решении
2](#i.-внутренние-дополнительные-структуры-данных-которые-будут-использоваться-в-решении)

[II. ТЕХНИЧЕСКИЙ БИЗНЕС-ПРОЦЕСС 4](#ii.-технический-бизнес-процесс)

[Товар поступает на склад 4](#товар-поступает-на-склад)

[В системе TEEZ_PVZ пользователи формируют маршрутный лист без указания
курьера
4](#в-системе-teez_pvz-пользователи-формируют-маршрутный-лист-без-указания-курьера)

[TEEZ_PVZ стучится в Coube по API методу "Загрузить маршрутный лист".
4](#teez_pvz-стучится-в-coube-по-api-методу-загрузить-маршрутный-лист.)

[Маршрутный лист (МЛ) могут редактировать все логисты компании (Teez)
5](#маршрутный-лист-мл-в-ui-coube-могут-редактировать-все-менеджеры-компании-teez)

[Логист назначает курьера на маршрутный лист.
6](#логист-назначает-курьера-на-маршрутный-лист.)

[Курьер нажимает "*начать путь*" 6](#курьер-нажимает-начать-путь)

[Курьер меняет статус точки маршрута
6](#курьер-меняет-статус-точки-маршрута)

[Автоматическое добавление необходимости вернуть товары на склад после
маршрута.
7](#автоматическое-добавление-необходимости-вернуть-товары-на-склад-после-маршрута.)

[Завершение маршрута, если нет возврата на курьерский склад
7](#завершение-маршрута-если-нет-возврата-на-курьерский-склад)

[Процессинг статусов возврата товаров на курьерский склад
7](#процессинг-статусов-возврата-товаров-на-курьерский-склад)

[Принудительное завершения маршрута Диспетчером, если есть возврат на
курьерский склад
9](#принудительное-завершения-маршрута-диспетчером-если-есть-возврат-на-курьерский-склад)

[III. АНАЛИТИКА 10](#iii.-аналитика)

## I. Внутренние дополнительные структуры данных , которые будут использоваться в решении

**Курьер (подтип водителя)**

+------------------------------+---------------------------------------+
| **Поле**                     | **Тип**                               |
+==============================+=======================================+
| Внутренний id пользователя в |                                       |
| COUBE                        |                                       |
+------------------------------+---------------------------------------+
| Интеграционные данные:       |                                       |
| массив                       |                                       |
+------------------------------+---------------------------------------+
| -   Объект массива           |                                       |
+------------------------------+---------------------------------------+
| -   Код внешней системы      | В данном случае только одно значение  |
|     (например "WMS",         | "TEEZ_PVZ"                            |
|     "ПВЗ-система" и т.д.)    |                                       |
+------------------------------+---------------------------------------+
| -   Внешний id пользователя  |                                       |
|     во внешней системе       |                                       |
+------------------------------+---------------------------------------+
| ФИО                          | Текстовое поле                        |
+------------------------------+---------------------------------------+
| Активен                      | Флаг                                  |
+------------------------------+---------------------------------------+
| Номер телефона               | Цифры по маске                        |
+------------------------------+---------------------------------------+
| Емейл                        | Текст по маске                        |
+------------------------------+---------------------------------------+
| Логистическая курьерская     | Перевозчик с типом "курьерская        |
| компания (ПЕРЕВОЗЧИК), к     | компания".                            |
| которой привязан             |                                       |
|                              | В данном случае всегда Teez           |
+------------------------------+---------------------------------------+
| Основной ПВЗ, который        | Идентификатор ПВЗ                     |
| контролирует данного курьера |                                       |
+------------------------------+---------------------------------------+
| Текущие геозоны за которые   | Список Id (Не будет в первом релизе,  |
| отвечает                     | остается как пожелание на будущее)    |
+------------------------------+---------------------------------------+
| Примечание                   | Текст                                 |
+------------------------------+---------------------------------------+
| Текущий статус               | В поездке / недоступен по другим      |
|                              | причинам / свободен                   |
+------------------------------+---------------------------------------+

**Справочник курьерских складов**

+------------------------------+---------------------------------------+
| **Поле**                     |                                       |
+==============================+=======================================+
| Name                         | Кастомное название склада             |
+------------------------------+---------------------------------------+
| Is pickup point              | ПВЗ                                   |
+------------------------------+---------------------------------------+
| External data                | Объект из двух полей                  |
+------------------------------+---------------------------------------+
| -   Integration system       | Означает внешнюю систему, с которой   |
|                              | выполняется основная интеграция этого |
|                              | справочника.                          |
|                              |                                       |
|                              | На данный момент здесь может быть     |
|                              | только одно значение:                 |
|                              |                                       |
|                              | TEEZ_PVZ                              |
+------------------------------+---------------------------------------+
| -   id                       | External ID склада, который           |
|                              | используется в общении между внешней  |
|                              | системой и COUBE                      |
+------------------------------+---------------------------------------+
| Адрес склада                 |                                       |
+------------------------------+---------------------------------------+
| Координаты склада на карте   |                                       |
+------------------------------+---------------------------------------+

[Как заполняется]{.underline}: пока неизвестно. Желательно получить от
Teez выгрузкуэтого справочника в виде Json-файла, затем руками на нашей
стороне преобразовать его и загрузить в COUBE.

**Информационные системы для интеграции**

  -----------------------------------------------------------------------
  **Информационные системы для     
  интеграции (в будущем            
  предполагается, что количество   
  будет расширяться)**             
  -------------------------------- --------------------------------------
  TEEZ_PVZ                         Основная "складская" система на ПВЗ

  Информационная система Teez Post Поначалу этой системе должны быть
                                   предоставлены доступы, аналогичные
                                   системе TEEZ_PVZ для интеграции по API
  -----------------------------------------------------------------------

## II. ТЕХНИЧЕСКИЙ БИЗНЕС-ПРОЦЕСС

### Товар поступает на склад

Этот шаг не автоматизируется в COUBE.

### В системе TEEZ_PVZ пользователи формируют маршрутный лист без указания курьера

### TEEZ_PVZ стучится в Coube по API методу "Загрузить маршрутный лист".

Объект адаптирован под текущую структуру данных TEEZ_PVZ :

**{**

> **\"waybill\": {**
>
> **\"id\": 123,** // идентификатор МЛ из TEEZ_PVZ
>
> **"deliveryType": "courier",** // ("courier" для курьерки или
> "marketplacedelivery")
>
> **"warehouseExternalId": "12345",** // (основной склад, с которого
> нужно забрать товар и затем вернуть остаток)
>
> **"responsibleManagerContactInfo": //** не обязательно в случае с TEEZ
>
> {"name": "Менеджер Алишер",
>
> "phone": "+7 000 000000"} // пока что текстовое поле

**"targetDeliveryDay": "2025-04-15",** // требуемая дата доставки

> **}**

"**deliveries\": \[ {**

> **"sort": "1" /**/ просто нумерация позиций в deliveries
>
> **\"isCourierWarehouse\": false,** // является ли точка курьерским
> складом Teez
>
> **"loadType": "unload"** // (тип точки маршрута, в нашем случае
> [всегда]{.underline} "unload", если это не курьерский склад; если
> курьерский склад, то поле пустое)
>
> **"deliveryDesiredDatetime": "14:30" //** не обязательное поле. Не
> может быть заполнено вместе с любым из следующих двух
>
> **"deliveryDesiredDatetimeafter": "14:30"** // не обязательное поле
>
> **"deliveryDesiredDatetimebefore": "15:30 //** не обязательное поле
>
> **"warehouseId": "12345" //** может быть заполнено только если
> \"is_courier_warehouse\" =true,
>
> **\"address\": \"г. Астана, ул. Пушкина 1\",** // текстовое поле,
> [обязательно]{.underline}
>
> **"isSmsRequired": false** // требуется ли фотоподтверждение
>
> **"isPhotoRequired": false** // требуется ли подтверждение по смс
>
> **"comment": ""** // общий комментарий к точке маршрута
>
> **\"receiver\": { // контакт адреса (получатель для разгрузки;
> отправитель для погрузки)**
>
> **\"name\": \"Иван Иванов\",** // текстовое поле, здесь должно быть
> название компании (если это юрлицо) и имя контактного лица
>
> **\"phone\": \"+77123456789\"** // текстовое поле
>
> **"orders":** **\[**
>
> **{**
>
> **"trackNumber": "AC-323123123"**,
>
> **\"externalId\": \"123456\"**, // идентификатор заказа из TEEZ_PVZ
> или TEEZ_POST
>
> **\"orderLoadType\": "unload"**, // обязательно: тип точки, в нашем
> случае [всегда]{.underline} unload
>
> **"positions":** \[{ /
>
> **"positionCode":** "1" // произвольный идентификатор или код позиции
>
> **"positionShortname": "холодильник, разгружать аккуратно**" //
> краткое название или описание товара
>
> **}\]**
>
> **}**

**\]**

**}**

**Обязательные поля:**

-   **waybill:**

    -   **id**

    -   **deliveryType**

    -   **warehouseExternalId**

-   **deliveries -- обязательно хотя бы один элемент в массиве:**

    -   **isCourierWarehouse**

    -   **loadType**

    -   **address**

    -   **isSmsRequired**

    -   **isPhotoRequired**

    -   **receiver**

        -   **name**

        -   **phone**

    -   **orders -- сам массив не обязателен, но если в нем есть
        элементы, то для них следующие поля обязательны:**

        -   **externalId**

        -   **orderLoadType**

    -   **positions сам массив не обязателен; но если в нем есть
        элементы, то для них следующие поля обязательны:**

        -   **positionCode**

[Дополнительные валидации:]{.underline}

1.  Не может быть больше одной точки с одинаковым номером точки sort.

2.  Если с таким id уже был загружен маршрутный лист, то выполняется
    проверка его статуса

    -   Если данный маршрут уже был провалидирован и взят в работу
        логистом в платформе COUBE, загрузка и обновление данного
        маршрутного листа не выполняется.

    -   Если он остается в статусе непровалидированного черновика -- то
        данный маршрутный лист перезаписывается (обновляется) в COUBE

Интеграция синхронна. Успешный ответ означает, что маршрутный лист
успешно создан.

Все импортированные в COUBE маршрутные листы записываются в статусе
"*Импортированный непровалидированный черновик*" (окончательное название
статусов для UI здесь и далее может корректироваться).

[Логирование импорта]{.underline}

И при успешной, и при неуспешной попытке интеграции, Coube записывает
лог событий (тип события = попытка создания маршрутного листа).

### TEEZ_PVZ стучится в Coube по API методу "РЕ-ИМПОРТ".

По отдельному методу, внешняя система может обновить любой ранее
импортированный маршрутный лист.

Маршрутный лист идентифицируется по ID, все остальные поля
перезаписываются новыми значеними, которые пришли в составе нового
запроса.

Структура маршрутного листа идентична первичному импорту.

При ре-импорте выполняются те же валидации, что при первичном импорте.

Важные ограничения:

-   Это возможно только пока маршрутный лист находится в статусе
    "импортированный черновик", до того как были внесены любые изменения
    из UI !

-   Это возможно только из той же системы, из которой маршрутный лист
    ранее был импортирован

### Маршрутный лист (МЛ) в UI Coube могут редактировать все менеджеры компании (Teez)

Логист должен визуально проверить и дозаполнить маршрутный лист через
интерфейс платформы COUBE. Он должен пройти все валидации,
предусмотренные для пользовательского интерфейса. В том числе, он должен
синхронизировать все адреса с картой.

После валидации маршрутный лист должен быть переведен в статус
"*Сохранено*" *(провалидированный черновик).*

При редактировании МЛ, логист может :

\- добавлять точки

\- удалять точки

\- изменять адрес точки

\- менять последовательность точек

Каждый факт изменения маршрутного листа логируется. (В ряде случаев с
детализацией истории, что именно было изменено).

### Логист назначает курьера на маршрутный лист.

Курьер получает уведомление об этом и должен подтвердить.

Когда курьер назначен, маршрутный лист не может быть назначен другому
курьеру без отключения от данного курьера.

Данному курьеру не может быть передано в работу больше одного
маршрутного листа одновременно.

### 

### Курьер нажимает "*начать путь*"

Курьеру отобраажется первая точка маршрута, он движется к ней.

### Курьер меняет статус точки маршрута

При приезде на точку, курьер нажимает одну из опций, изменяющих статус
точки (заказа):

Для точек разгрузки:

  -----------------------------------------------------------------------
  "**Приехал, выполнил доставку**" **+ код из СМС клиента** (обязательно
  если это запрошено в заказе) + **скан** (обязательно, если это
  запрошено в заказе)
  -----------------------------------------------------------------------
  "**Приехал, выполнил доставку, но покупатель сделал возврат**" **+ код
  из СМС клиента** (обязательно если это запрошено в заказе) + **скан**
  (обязательно, если это запрошено в заказе)

  "**Приехал, выполнил доставку, но покупатель сделал частичный
  возврат**" + **перечень возвращенных позиций** **+ код из СМС клиента**
  (обязательно если это запрошено в заказе) + **скан** (обязательно, если
  это запрошено в заказе)

  "**Приехал, но не отдал заказ**" (две разновидности: "Customer not
  accessed" или "Customer postponed")
  -----------------------------------------------------------------------

Кроме того, курьер может заполнить поле ***Комментарий***.

Для точек погрузки (в случае с TEEZ на данный момент эта
функциональность не используется):

  -----------------------------------------------------------------------
  "**Приехал, принял товар**" **+ код из СМС клиента** (обязательно если
  это запрошено в заказе) + **скан** (обязательно, если это запрошено в
  заказе)
  -----------------------------------------------------------------------
  "**Приехал, принял товар, но покупатель потом снова забрал товар**"

  "**Приехал, частично забрал**" + **перечень забранных позиций** **+ код
  из СМС клиента** (обязательно если это запрошено в заказе) + **скан**
  (обязательно, если это запрошено в заказе)

  "**Приехал, но не принял товар**" (две разновидности: "Customer not
  accessed" или "Customer postponed")
  -----------------------------------------------------------------------

Кроме того, курьер может заполнить поле ***Комментарий***.

[Примечание]{.underline}: Описаны содеражтельные действия, не их
названия для UI (кнопки и их названия для UI регулируются в дизайне!)

### Автоматическое добавление необходимости вернуть товары на склад после маршрута.

Как только курьер:

-   принял товар

-   получил возврат от покупателя

-   не смог отдать заказ

автоматически формируется необходимость вернуть товары на курьерский
склад. Это значит, что такой маршрут по умолчанию не будет полностью
закрыт, если COUBE не узнает о том, что возврат на склад был осуществлен
(подробное описание процесса см. ниже).

### Завершение маршрута, если нет возврата на курьерский склад

Курьер завершил последний адрес по маршрутному листу -- маршрутный лист
автоматически закрывается.

### Процессинг статусов возврата товаров на курьерский склад

**Шаг 1.** Когда курьер проходит последнюю точку -- система подбивает
итоги и выводит ему в мобильному приложение "Отчет что вернуть на
склад".

**Шаг 2.** Coube синхронизируется с TEEZ_PVZ **("Синхронизировать
статусы товаров, подлежащих к возврату на склад").**

> Должны синхронизироваться следующие данные:
>
> **{**
>
> **"record_datetime": "", //** дата, когда в Coube зафиксирована
> информация о том, что этот товар будет подлежать возврату на склад
>
> **"track_number": "AC-323123123",**
>
> **\"externalId\": \"123456\",**
>
> **\"teezpostId\": "123",**
>
> **\"address": "",** // адрес точки маршрута, к которой относился этот
> заказ, передается как текст
>
> **\"reason\": "returned",**
>
> **\"to_return_partially": true,**
>
> **"parts": {** // обязательно если to_return_partially; здесь
> перечисляются только те позиции, которые подлежат возврату на склад
>
> **\"position_code\": 123,** // идентификатор товара из TEEZ_PVZ
>
> **"position_name": "холодильник\...",** // (краткая характеристика
> товара)
>
> **},**
>
> **\"waybill_id": 123,**
>
> **"responsible_courier_warehouse_id": "12345"** (ответственный склад)
>
> **\"courier_email": "",**

**}**

> [Примечание]{.underline}**:** поле Record_datetime используется для
> ретраев, чтобы система-получатель всегда знала, к какому времени
> относится данный запрос метода).
>
> Возможные значения поля reason:

+------------+---------------------------------------------------------+
| **Поле**   | **Тип данных и что значит**                             |
+============+=========================================================+
| reason     | Enum:                                                   |
|            |                                                         |
|            | \- received_success (в TEEZ не используется) (товар     |
|            | получен от отправителя для передачи на склад)           |
|            |                                                         |
|            | \- returned                                             |
|            |                                                         |
|            | \- customer_not_available                               |
|            |                                                         |
|            | \- customer_postponed                                   |
|            |                                                         |
|            | \- force_majeure                                        |
|            |                                                         |
|            | received_success означает, что груз был успешно         |
|            | получен.                                                |
|            |                                                         |
|            | Остальные значения означают разновидности неуспешной    |
|            | доставки.                                               |
+------------+---------------------------------------------------------+

**Шаг 3**. (Вне рамок системы Coube):

В системе TEEZ_PVZ сотрудник ПВЗ отмечает список товаров, которые курьер
действительно вернул на склад

**Шаг 4**. TEEZ_PVZ стучится в Coube **по методу "Сообщить список
возвращенных товаров"**.

> **{**
>
> **"record_datetime": "", //** дата, когда товар возвращен на склад
>
> **"track_number": "AC-323123123",** // трек-номер заказа
>
> **\"externalId\": \"123456\",** // айди заказа
>
> **\"teezpostId\": "123",** // айди заказа
>
> **\"warehouse": "",** // склад, принявший товар (указывается
> интеграционный id склада для Coube)
>
> **\"order_had_multilple_positions": true, //** имел ли заказ вложенные
> товары
>
> **"parts": {** // этот блок заполнен только если заказ имеет вложенные
> товары
>
> **\"position_code\": 123,** // идентификатор товара из TEEZ_PVZ
>
> **\"position_is_returned\": true,** // пока что есть смысл отправлять
> только позиции с true
>
> **},**
>
> **\"waybill_id": 123,** // маршрутный лист
>
> **\"courier_email": "", //** от кого был принят

**}**

Обязательные поля:

-   \"externalId\" ИЛИ \"teezpostId\" ([внимание]{.underline}, для
    корректной работы интеграции должно быть отправлено то поле, которое
    изначально отправлялось в маршрутном листе!)

-   \"warehouse"

-   \"order_had_multiple_positions" (внимание: если на этапе создания
    маршрутного листа в этом заказе было больше одного товара, в этом
    поле нельзя передавать "false"!)

-   "parts" -- обязательно, если заказ имеет вложенные товары (при этом
    обязательны оба поля

    -   position_code -- обязательно, если заполнен блок parts

    -   position_is_returned -- обязательно, если заполнен блок parts

-   waybill_id": 123,

**Шаг 5.** У курьера разблокируется кнопка "Завершить поездку", он ее
нажимает.

Обратить внимание: курьер не может завершить поездку, пока из TEEZ_PVZ
не придет по API в COUBE возврат товаров.

### Принудительное завершения маршрута Диспетчером, если есть возврат на курьерский склад

Если из из TEEZ_PVZ не пришел в COUBE возврат товаров, логист
(диспетчер) может завершить поездку принудительно.

### 

### 

### 

## III. АНАЛИТИКА

**1. Краткий дашборд на фронтэнде моб приложения**

Для доставки типа "разгрузка" - общие итоги в количестве:

-   \- заказы доставленные

-   \- заказы возвращенные

-   \- заказы не доставленные, по причине клиента

-   \- заказы не доставленные, потому что курьер не доехал

**2. Подробный отчет в таблице**

**Формат:** для начала это может быть выгрузка в Excel

**Поля по столбцам:**

-   id заказа

-   текущий статус

-   дата-время определения текущего статуса

-   курьер

-   номер маршрутного листа, в который был включен этот заказ

**Строки**:

-   id заказов

**Дополнительные комментарии:**

На данный момент отчет формируется только для доставки типа "разгрузка".
