



**Проект продукта: курьерская доставка**




**Содержание**

[I. Дополнительные структуры данных , которые будут использоваться в решении	2](#__refheading___toc221_1277074719)

[II. ТЕХНИЧЕСКИЙ БИЗНЕС-ПРОЦЕСС	4](#__refheading___toc223_1277074719)

[Товар поступает на склад	4](#__refheading___toc225_1277074719)

[В системе TEEZ_PVZ пользователи формируют маршрутный лист без указания курьера	4](#__refheading___toc18_435035093)

[TEEZ_PVZ стучится в Coube по API методу “Загрузить маршрутный лист”.	4](#__refheading___toc227_1277074719)

[Маршрутный лист (МЛ) могут редактировать все логисты компании “Курьерская компания”(Teez)	5](#__refheading___toc229_1277074719)

[Логист назначает курьера на маршрутный лист.	5](#__refheading___toc231_1277074719)

[Курьер нажимает “начать путь”	6](#__refheading___toc235_1277074719)

[Курьер меняет статус точки маршрута	6](#__refheading___toc237_1277074719)

[Обычное завершение маршрута курьером	6](#__refheading___toc20_435035093)

[Форс-мажорные ситуации	6](#__refheading___toc239_1277074719)

[Coube стучится в TEEZ_PVZ по методу “Итоги работы по маршрутному листу”	8](#__refheading___toc241_1277074719)

[Логист закрывает поездку в COUBE.	8](#__refheading___toc245_1277074719)

[III. АНАЛИТИКА	8](#__refheading___toc560_1277074719)



## <a name="__refheading___toc221_1277074719"></a>**I. Дополнительные структуры данных , которые будут использоваться в решении**

**Курьер (подтип водителя)**

|**Поле**|**Тип**|
| - | - |
|Внутренний id пользователя в COUBE||
|Интеграционные данные: массив||
|- Объект массива||
|- Код внешней системы (например “WMS”, “ПВЗ-система” и т.д.)|В данном случае только одно значение “TEEZ\_PVZ”|
|- Внешний id пользователя во внешней системе||
|ФИО|Текстовое поле|
|Активен|Флаг|
|Номер телефона|Цифры по маске|
|Емейл|Текст по маске|
|Логистическая курьерская компания (ПЕРЕВОЗЧИК), к которой привязан|<p>Перевозчик с типом “курьерская компания”.</p><p>В данном случае всегда Teez</p>|
|Основной ПВЗ, который контролирует данного курьера|Идентификатор ПВЗ|
|Текущие геозоны за которые отвечает|Список Id (Не будет в первом релизе, остается как пожелание на будущее)|
|Примечание|Текст|
|Текущий статус|В поездке / недоступен по другим причинам / свободен|


**Причины, почему заказ не отдан в руки**

|**Значение в енаме:**||
| - | - |
|customer\_not\_available|- Не дозвонился/никто не открыл|
|customer\_postponed|- Клиент попросил не доставлять сейчас|
|force\_majeure|- Форс-мажорные прочие причины|

Как заполняется: хардкодом.

Пока что закладываем эти два значения в енам, затем могут поступить другие значения от Teez.


**Справочник курьерских складов**

|**Поле**||
| - | - |
|Name|Кастомное название склада|
|Is pickup point|ПВЗ|
|External data|Объект из двух полей|
|- Integration system|<p>Означает внешнюю систему, с которой выполняется основная интеграция этого справочника.</p><p></p><p>На данный момент здесь может быть только одно значение:</p><p>TEEZ\_PVZ</p>|
|- id|External ID склада, который используется в общении между внешней системой и COUBE|
|Адрес склада||
|Координаты склада на карте||

Как заполняется: пока неизвестно. Желательно получить от Teez выгрузкуэтого справочника в виде Json-файла, затем руками на нашей стороне преобразовать его и загрузить в COUBE.


## <a name="__refheading___toc223_1277074719"></a>**II. ТЕХНИЧЕСКИЙ БИЗНЕС-ПРОЦЕСС**


### <a name="__refheading___toc225_1277074719"></a>**Товар поступает на склад**
Этот шаг не автоматизируется в COUBE.

### <a name="__refheading___toc18_435035093"></a>**В системе TEEZ\_PVZ пользователи формируют маршрутный лист без указания курьера**

### <a name="__refheading___toc227_1277074719"></a>**TEEZ\_PVZ стучится в  Coube по API методу “Загрузить маршрутный лист”.**

Объект будет адаптирован под текущую структуру данных TEEZ\_PVZ (см. на следующей странице):

**{**

**"waybill": {** 

**"id": 123,** // идентификатор МЛ из  TEEZ\_PVZ

**“delivery\_type”: “courier”,** // (“courier” или “marketplacedelivery”)

**“responsible\_courier\_warehouse\_id”: “12345”,** // (ответственный склад)  

`	 `**“target\_delivery\_day”: “2025-04-15”,** // требуемая дата доставки

**}**

`	 `“**deliveries": [ {**

`      `**“sort”: “1” /**/ просто нумерация позиций в deliveries

`      `**"is\_courier\_warehouse": false,** // является ли точка нашим курьерским складом (по умолчанию нет)

`       `**“load\_type”: “unload”**  // (тип точки маршрута, в нашем случае всегда “unload”, если это не курьерский склад; если курьерский склад, то поле пустое)

**“delivery\_desired\_datetime”: “14:30” //** не обязательное поле. Не может быть заполнено вместе с любым из следующих двух

`       `**“delivery\_desired\_datetimeafter”: “14:30”** // не обязательное поле

`       `**“delivery\_desired\_datetimebefore”: “15:30 //**  не обязательное поле

`      `**“warehouse\_id”: “12345” //** может быть заполнено только если "is\_courier\_warehouse" =true,

`      `**"address": "г. Астана, ул. Пушкина 1",** //  текстовое поле, обязательно если warehouse\_id пустое

`      `**“is\_sms\_required”: false** // требуется ли фотоподтверждение

`      `**“is\_photo\_required”: false** // требуется ли подтверждение по смс

`      `**“comment”: “”** // общий комментарий к точке маршрута

`      `**"receiver": {**

`  `**"name": "Иван Иванов",** //  текстовое поле, здесь должно быть название компании (если это юрлицо) и имя контактного лица

`      `**"phone": "+77123456789"** //  текстовое поле
**\
`       `**“orders”:** **[**

`	`**{**

`	`**“track\_number”: “AC-323123123”**,

`	`**"externalId": "123456"**, //  идентификатор заказа из  TEEZ\_PVZ

`	`**"teezpostId": “123”**, //  идентификатор заказа из  TEEZ\_POST

`	`**"order\_load\_type": “unload”**, // обязательно: тип точки, в нашем случае всегда unload

**“positions”:** [{    /

`      `**“position\_code”:** “1” // произвольный идентификатор или код позиции

`      `**“position\_shortname”: “холодильник, разгружать аккуратно**” // краткое название или описание товара

` `}]

`	`**}**

**]**

`  `**}**

`  `**]**

**}**

**}**

Обратить внимание: из API исключены такие поля, как:

"createdDate": "2025-04-15T07:39:00.360232Z"

"receivedFromCustomerDate": "2025-03-29"

"companyName": "Sending company"

"legal\_entity\_name": “ТОО Ромашка” 

"is\_legal\_entity": true  // (новое поле)

“externalBarcode": "123456" (теперь называется track\_number)


Дополнительные валидации:

1. Не может быть больше одной точки с одинаковым номером точки sort. 
1. Последней точкой маршрута должен быть наш склад. Если это не так, то после импорта он будет автоматически добавлен в платформе COUBE
1. Если с таким id уже был загружен маршрутный лист, то выполняется проверка его статуса
   - Если данный маршрут уже был провалидирован и взят в работу логистом в платформе COUBE, загрузка и обновление данного маршрутного листа не выполняется. 
   - Если он остается в статусе непровалидированного черновика – то данный маршрутный лист перезаписывается (обновляется) в  COUBE


Все импортированные в COUBE маршрутные листы записываются в статусе “*Импортированный непровалидированный черновик*” (окончательное название статусов для UI здесь и далее может корректироваться).

Логирование импорта

И при успешной, и при неуспешной попытке интеграции, Coube записывает лог событий (тип события = попытка создания маршрутного листа).


### <a name="__refheading___toc229_1277074719"></a>**Маршрутный лист (МЛ) могут редактировать все логисты компании (Teez)**

Логист должен визуально проверить и дозаполнить маршрутный лист  через интерфейс платформы COUBE. Он должен пройти все валидации, предусмотренные для пользовательского интерфейса. В том числе, он должен синхронизировать все адреса с картой. 

После валидации возможно перевести маршрутный лист в статус “*Сохранено*” *(провалидированный черновик).*

При редактировании МЛ, логист может :

\- добавлять точки

\- удалять точки

\- изменять адрес точки

\- менять последовательность точек

Каждый факт изменения маршрутного листа логируется. (В ряде случаев с детализацией истории, что именно было изменено).

### <a name="__refheading___toc231_1277074719"></a>**Логист назначает курьера на маршрутный лист.**

Курьер получает уведомление об этом и должен подтвердить.

Когда курьер назначен, маршрутный лист не может быть назначен другому курьеру без отключения от данного курьера.

Данному курьеру не может быть передано в работу больше одного маршрутного листа одновременно.
###
### <a name="__refheading___toc235_1277074719"></a>**Курьер нажимает “*начать путь*”**
Курьеру отобраажется первая точка маршрута, он движется к ней.


### <a name="__refheading___toc237_1277074719"></a>**Курьер меняет статус точки маршрута**
При приезде на точку, курьер нажимает одну из опций, изменяющих статус точки (заказа): 

Для точек разгрузки:

|“**Приехал, выполнил доставку**” **+ код из СМС клиента** (обязательно если это запрошено в заказе) + **скан** (обязательно, если это запрошено в заказе)|
| - |
|“**Приехал, выполнил доставку, но покупатель сделал возврат**” **+ код из СМС клиента** (обязательно если это запрошено в заказе) + **скан** (обязательно, если это запрошено в заказе)|
|“**Приехал, выполнил доставку, но покупатель сделал частичный возврат**” + **перечень возвращенных позиций** **+ код из СМС клиента** (обязательно если это запрошено в заказе) + **скан** (обязательно, если это запрошено в заказе)|
|“**Приехал, но не отдал заказ**” (две разновидности: “Customer not accessed” или “Customer postponed”) |

Кроме того, курьер может заполнить поле ***Комментарий***.

Для точек погрузки (в случае с TEEZ на данный момент эта функциональность не используется):

|“**Приехал, принял товар**” **+ код из СМС клиента** (обязательно если это запрошено в заказе) + **скан** (обязательно, если это запрошено в заказе)|
| - |
|“**Приехал, принял товар, но покупатель потом снова забрал товар**”|
|“**Приехал, частично забрал**” + **перечень забранных позиций** **+ код из СМС клиента** (обязательно если это запрошено в заказе) + **скан** (обязательно, если это запрошено в заказе)|
|“**Приехал, но не принял товар**” (две разновидности: “Customer not accessed” или “Customer postponed”) |

Кроме того, курьер может заполнить поле ***Комментарий***.

Примечание: Описаны содеражтельные действия, не их названия для UI (кнопки и их названия для UI регулируются в дизайне!)


### <a name="__refheading___toc20_435035093"></a>**Обычное завершение маршрута курьером**
Курьер доезжает до точки последнего заказа. После этого автоматически меняется статус поездки “Маршрут выполнен, остался возврат на склад”.

После этого курьер едет на склад Teez. 

Там он нажимает кнопку “Завершил поездку”.

###
###

### <a name="__refheading___toc241_1277074719"></a>**Coube стучится в TEEZ\_PVZ по методу “Сообщить список товаров к возврату на склад”** 

Когда курьер проходит последнюю точку (не считая точку финального курьерского склада) или нажимает завершить маршрут – система подбивает итоги и выводит отчет ему в мобильному приложение.

Платформа Coube стучится в  TEEZ\_PVZ (на это предусмотрен ретрай – раз в 30 минут в течение 24 часов) с отчетом о товарах, которые ожидают доставки на курьерский склад.

Отправляемые поля:

**{**

**“record\_datetime”: “”, //** дата, когда этот возврат стал актуален

**“track\_number”: “AC-323123123”,**

**"externalId": "123456", /**

**"teezpostId": “123”,** 

**"address”: “”,** // адрес, на который должна была пройти доставка

**"reason": “returned”,** 

**"to\_return\_partially”: true,** 

**“parts”: { //** 

`	`**"position\_code": 123,** // идентификатор МЛ из  TEEZ\_PVZ

`	`**“position\_name”: “courier”,** // (“courier” или “marketplacedelivery”)

**},**

**"waybill\_id”: 123,** 

**“responsible\_courier\_warehouse\_id”: “12345”** (ответственный склад)  

**"courier\_email”: “”,**


Примечание**:** поле Record\_datetime используется для ретраев, чтобы система-получатель всегда знала, к какому времени относится данный запрос метода).

Возможные значения поля:

|**Поле**|**Тип данных и что значит**|
| :- | - |
|reason|<p>Enum:</p><p>- received\_success (в TEEZ не используется) (товар получен от отправителя для передачи на склад) </p><p>- returned</p><p>- customer\_not\_available</p><p>- customer\_postponed</p><p>- force\_majeure</p><p></p><p>received\_success означает, что груз был успешно получен.</p><p>Остальные значения означают разновидности неуспешной доставки. </p>|


###




## <a name="__refheading___toc560_1277074719"></a>**III. АНАЛИТИКА**

**1. Краткий дашборд на фронтэнде моб приложения**

Для доставки типа “разгрузка” - общие итоги в количестве: 

- - заказы доставленные
- - заказы возвращенные
- - заказы не доставленные, по причине клиента
- - заказы не доставленные, потому что курьер не доехал


**2. Подробный отчет в таблице**

**Формат:** для начала это может быть выгрузка в Excel

**Поля по столбцам:**

- id заказа
- текущий статус
- дата-время определения текущего статуса
- курьер
- номер маршрутного листа, в который был включен этот заказ



**Строки**: 

- id заказов

**Дополнительные:**

На данный момент формируется только для доставки типа “разгрузка” 
7
