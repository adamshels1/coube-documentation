# 14. –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-10
**–°—Ç–∞—Ç—É—Å**: TO DO
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: MEDIUM
**–ê–≤—Ç–æ—Ä**: Ali (Product Requirements)

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–ë–∏–∑–Ω–µ—Å-–∫–µ–π—Å:**
–ó–∞–∫–∞–∑—á–∏–∫ —Ö–æ—á–µ—Ç –∑–Ω–∞—Ç—å:
- –ì–¥–µ —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫—É—Ä—å–µ—Ä?
- –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—Ä–∏–µ–¥–µ—Ç?
- –ö—Ç–æ –∫—É—Ä—å–µ—Ä –∏ –∫–∞–∫ —Å –Ω–∏–º —Å–≤—è–∑–∞—Ç—å—Å—è?

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –ó–∞–∫–∞–∑—á–∏–∫ –Ω–µ –≤–∏–¥–∏—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞
- –ù–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
- –ó–∞–∫–∞–∑—á–∏–∫ –∑–≤–æ–Ω–∏—Ç –ª–æ–≥–∏—Å—Ç—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ "–≥–¥–µ –∫—É—Ä—å–µ—Ä?"

**–†–µ—à–µ–Ω–∏–µ:**
–õ–æ–≥–∏—Å—Ç –º–æ–∂–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º, –≥–¥–µ –±—É–¥–µ—Ç:
- üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å real-time –ø–æ–∑–∏—Ü–∏–µ–π –∫—É—Ä—å–µ—Ä–∞
- üë§ –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫—É—Ä—å–µ—Ä–∞ (–§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω)
- üìç –ú–∞—Ä—à—Ä—É—Ç —Å —Ç–æ—á–∫–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚è±Ô∏è ETA (–æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è)
- üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## üéØ –†–µ—à–µ–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –õ–æ–≥–∏—Å—Ç    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ‚îÄ‚îÄ‚îÄ>‚îÇ Tracking URL ‚îÇ
‚îÇ  (Web UI)   ‚îÇ     —Ç–æ–∫–µ–Ω          ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
                                   shares ‚îÇ
                                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ó–∞–∫–∞–∑—á–∏–∫   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ Public Page  ‚îÇ
‚îÇ  (Browser)  ‚îÇ      —Å—Å—ã–ª–∫—É        ‚îÇ  /tracking/  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
                                   polling ‚îÇ 15-30s
                                          ‚Üì
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚îÇ Public API   ‚îÇ
                                   ‚îÇ (no auth)    ‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
                                          ‚Üì
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚îÇ   Database   ‚îÇ
                                   ‚îÇ transportation‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üóÑÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

### 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `public_tracking_token` –≤ —Ç–∞–±–ª–∏—Ü—É `transportation`

**Migration:** `V20251110000000__add_public_tracking_token_to_transportation.sql`

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
ALTER TABLE applications.transportation
ADD COLUMN public_tracking_token UUID DEFAULT NULL;

-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE UNIQUE INDEX idx_transportation_tracking_token
ON applications.transportation (public_tracking_token)
WHERE public_tracking_token IS NOT NULL;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
COMMENT ON COLUMN applications.transportation.public_tracking_token
IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
```

---

## üîß Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. Entity: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ `Transportation`

**File:** `coube-backend/src/main/java/kz/coube/backend/applications/entity/Transportation.java`

```java
@Entity
@Table(name = "transportation", schema = "applications")
public class Transportation extends BaseIdEntity {

    // ... existing fields

    @Column(name = "public_tracking_token", unique = true)
    private UUID publicTrackingToken;

    // ... existing methods
}
```

---

### 2. Repository: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–æ–∫–µ–Ω—É

**File:** `coube-backend/src/main/java/kz/coube/backend/applications/repository/TransportationRepository.java`

```java
@Repository
public interface TransportationRepository extends JpaRepository<Transportation, Long> {

    // ... existing methods

    /**
     * –ù–∞–π—Ç–∏ transportation –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
     */
    Optional<Transportation> findByPublicTrackingToken(UUID token);
}
```

---

### 3. Service: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/service/PublicTrackingService.java`

```java
package kz.coube.backend.courier.service;

import kz.coube.backend.applications.TransportationService;
import kz.coube.backend.applications.entity.CourierRouteOrder;
import kz.coube.backend.applications.entity.Transportation;
import kz.coube.backend.common.exception.ResourceNotFoundException;
import kz.coube.backend.courier.dto.PublicTrackingResponse;
import kz.coube.backend.dictionaries.enumeration.TransportationType;
import kz.coube.backend.organization.model.Employee;
import kz.coube.backend.route.entity.CargoLoadingHistory;
import kz.coube.backend.transport.entity.Vehicle;
import kz.coube.backend.transport.entity.VehicleLatestLocation;
import kz.coube.backend.transport.repository.VehicleLatestLocationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class PublicTrackingService {

    private final TransportationService transportationService;
    private final VehicleLatestLocationRepository vehicleLatestLocationRepository;
    private final CourierRouteOrderService courierRouteOrderService;

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è transportation
     */
    @Transactional
    public String generateOrGetTrackingToken(Long transportationId) {
        Transportation transportation = transportationService.findById(transportationId);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è COURIER_DELIVERY
        if (transportation.getTransportationType() != TransportationType.COURIER_DELIVERY) {
            throw new IllegalStateException("Public tracking is only available for courier delivery");
        }

        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å - –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ
        if (transportation.getPublicTrackingToken() != null) {
            return transportation.getPublicTrackingToken().toString();
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
        UUID token = UUID.randomUUID();
        transportation.setPublicTrackingToken(token);
        transportationService.save(transportation);

        log.info("Generated public tracking token for transportation {}: {}",
                 transportationId, token);

        return token.toString();
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (–ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
     */
    @Transactional(readOnly = true)
    public PublicTrackingResponse getTrackingData(String tokenStr) {
        UUID token;
        try {
            token = UUID.fromString(tokenStr);
        } catch (IllegalArgumentException e) {
            throw new ResourceNotFoundException("Invalid tracking token");
        }

        // –ù–∞–π—Ç–∏ transportation –ø–æ —Ç–æ–∫–µ–Ω—É
        Transportation transportation = transportationService
            .findByPublicTrackingToken(token)
            .orElseThrow(() -> new ResourceNotFoundException("Tracking not found"));

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—å–µ—Ä–∞
        PublicTrackingResponse.CourierLocation location = null;
        if (transportation.getTransport() != null &&
            transportation.getTransport().getVehicle() != null) {

            Vehicle vehicle = transportation.getTransport().getVehicle();
            VehicleLatestLocation latestLocation = vehicleLatestLocationRepository
                .findById(vehicle.getId())
                .orElse(null);

            if (latestLocation != null && latestLocation.getLocation() != null) {
                location = PublicTrackingResponse.CourierLocation.builder()
                    .latitude(latestLocation.getLocation().getY())
                    .longitude(latestLocation.getLocation().getX())
                    .timestamp(latestLocation.getTimestamp())
                    .build();
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—å–µ—Ä–µ
        PublicTrackingResponse.CourierInfo courierInfo = getCourierInfo(transportation);

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        List<PublicTrackingResponse.RoutePoint> routePoints = getRoutePoints(transportation);

        // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        PublicTrackingResponse.Progress progress = calculateProgress(transportation);

        // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ETA
        LocalDateTime eta = calculateETA(transportation, location);

        return PublicTrackingResponse.builder()
            .transportationId(transportation.getId())
            .status(transportation.getStatus().name())
            .statusDescription(getStatusDescription(transportation.getStatus()))
            .courierLocation(location)
            .courierInfo(courierInfo)
            .routePoints(routePoints)
            .progress(progress)
            .eta(eta)
            .createdAt(transportation.getCreatedAt())
            .build();
    }

    private PublicTrackingResponse.CourierInfo getCourierInfo(Transportation transportation) {
        Employee courier = transportation.getExecutorEmployee();
        if (courier == null && transportation.getTransport() != null) {
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ —á–µ—Ä–µ–∑ Transport
            // (–ª–æ–≥–∏–∫–∞ –∏–∑ DriverService.driverForTransportation)
            courier = null; // TODO: implement if needed
        }

        if (courier == null) {
            return PublicTrackingResponse.CourierInfo.builder()
                .fullName("–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω")
                .phone(null)
                .build();
        }

        return PublicTrackingResponse.CourierInfo.builder()
            .fullName(courier.getFullName())
            .phone(courier.getPhone())
            .build();
    }

    private List<PublicTrackingResponse.RoutePoint> getRoutePoints(Transportation transportation) {
        List<CargoLoadingHistory> cargoLoadings = transportation.getCargoLoadings();
        if (cargoLoadings == null || cargoLoadings.isEmpty()) {
            return List.of();
        }

        return cargoLoadings.stream()
            .filter(cl -> !Boolean.TRUE.equals(cl.getIsCourierWarehouse())) // –°–∫—Ä—ã—Ç—å —Å–∫–ª–∞–¥—ã
            .map(cl -> {
                // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
                List<CourierRouteOrder> orders = courierRouteOrderService.getByCargoLoadingHistory(cl);

                return PublicTrackingResponse.RoutePoint.builder()
                    .orderNum(cl.getOrderNum())
                    .address(cl.getAddress())
                    .contactName(cl.getContactName())
                    .contactPhone(cl.getContactNumber())
                    .isCompleted(cl.getIsActive() == null || !cl.getIsActive())
                    .isCurrentPoint(Boolean.TRUE.equals(cl.getIsActive()))
                    .orderCount(orders.size())
                    .build();
            })
            .collect(Collectors.toList());
    }

    private PublicTrackingResponse.Progress calculateProgress(Transportation transportation) {
        List<CargoLoadingHistory> cargoLoadings = transportation.getCargoLoadings();
        if (cargoLoadings == null || cargoLoadings.isEmpty()) {
            return PublicTrackingResponse.Progress.builder()
                .totalPoints(0)
                .completedPoints(0)
                .currentPoint(0)
                .build();
        }

        long completed = cargoLoadings.stream()
            .filter(cl -> cl.getIsActive() == null || !cl.getIsActive())
            .count();

        int currentPoint = cargoLoadings.stream()
            .filter(cl -> Boolean.TRUE.equals(cl.getIsActive()))
            .findFirst()
            .map(CargoLoadingHistory::getOrderNum)
            .orElse(cargoLoadings.size());

        return PublicTrackingResponse.Progress.builder()
            .totalPoints(cargoLoadings.size())
            .completedPoints((int) completed)
            .currentPoint(currentPoint)
            .build();
    }

    private LocalDateTime calculateETA(Transportation transportation,
                                       PublicTrackingResponse.CourierLocation location) {
        // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞: –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        CargoLoadingHistory activePoint = transportation.getCargoLoadings().stream()
            .filter(cl -> Boolean.TRUE.equals(cl.getIsActive()))
            .findFirst()
            .orElse(null);

        if (activePoint == null) {
            return null; // –ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
        }

        // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç ETA –Ω–∞ –æ—Å–Ω–æ–≤–µ:
        // - –¢–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—å–µ—Ä–∞
        // - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
        // - –°—Ä–µ–¥–Ω–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        // - –ü—Ä–æ–±–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)

        // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: +30 –º–∏–Ω—É—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        return LocalDateTime.now().plusMinutes(30);
    }

    private String getStatusDescription(kz.coube.backend.dictionaries.enumeration.TransportationStatus status) {
        return switch (status) {
            case DRIVER_ACCEPTED -> "–ö—É—Ä—å–µ—Ä –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑";
            case ON_THE_WAY -> "–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏";
            case AWAITING_RETURN_CONFIRMATION -> "–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞";
            case FINISHED -> "–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
            default -> status.name();
        };
    }
}
```

---

### 4. DTO: Response –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/dto/PublicTrackingResponse.java`

```java
package kz.coube.backend.courier.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.Builder;

import java.time.LocalDateTime;
import java.util.List;

@Builder
@JsonInclude(JsonInclude.Include.NON_NULL)
public record PublicTrackingResponse(
    Long transportationId,
    String status,
    String statusDescription,
    CourierLocation courierLocation,
    CourierInfo courierInfo,
    List<RoutePoint> routePoints,
    Progress progress,
    LocalDateTime eta,
    LocalDateTime createdAt
) {
    @Builder
    public record CourierLocation(
        Double latitude,
        Double longitude,
        LocalDateTime timestamp
    ) {}

    @Builder
    public record CourierInfo(
        String fullName,
        String phone
    ) {}

    @Builder
    public record RoutePoint(
        Integer orderNum,
        String address,
        String contactName,
        String contactPhone,
        Boolean isCompleted,
        Boolean isCurrentPoint,
        Integer orderCount
    ) {}

    @Builder
    public record Progress(
        Integer totalPoints,
        Integer completedPoints,
        Integer currentPoint
    ) {}
}
```

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/dto/GenerateTrackingLinkResponse.java`

```java
package kz.coube.backend.courier.dto;

import lombok.Builder;

@Builder
public record GenerateTrackingLinkResponse(
    Long transportationId,
    String trackingToken,
    String trackingUrl,
    String qrCodeUrl  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: URL –¥–ª—è QR-–∫–æ–¥–∞
) {}
```

---

### 5. Controller: –ü—É–±–ª–∏—á–Ω—ã–π API (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/api/PublicTrackingController.java`

```java
package kz.coube.backend.courier.api;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import kz.coube.backend.courier.dto.PublicTrackingResponse;
import kz.coube.backend.courier.service.PublicTrackingService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.CacheControl;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.concurrent.TimeUnit;

@RestController
@RequestMapping("/api/v1/public/tracking")
@RequiredArgsConstructor
@Tag(name = "Public Tracking", description = "–ü—É–±–ª–∏—á–Ω–æ–µ API –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)")
public class PublicTrackingController {

    private final PublicTrackingService publicTrackingService;

    @GetMapping("/{token}")
    @Operation(
        summary = "–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ –ø–æ —Ç–æ–∫–µ–Ω—É",
        description = "–ü—É–±–ª–∏—á–Ω—ã–π endpoint –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—å–µ—Ä–∞, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –º–∞—Ä—à—Ä—É—Ç, ETA."
    )
    public ResponseEntity<PublicTrackingResponse> getTracking(
        @PathVariable String token
    ) {
        PublicTrackingResponse response = publicTrackingService.getTrackingData(token);

        // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 15 —Å–µ–∫—É–Ω–¥ (–¥–ª—è polling)
        return ResponseEntity.ok()
            .cacheControl(CacheControl.maxAge(15, TimeUnit.SECONDS))
            .body(response);
    }
}
```

---

### 6. Controller: API –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏)

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/api/CourierTrackingManagementController.java`

```java
package kz.coube.backend.courier.api;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import kz.coube.backend.auth.annotations.AuthorizationRequired;
import kz.coube.backend.auth.roles.KeycloakRole;
import kz.coube.backend.courier.dto.GenerateTrackingLinkResponse;
import kz.coube.backend.courier.service.PublicTrackingService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/courier/tracking")
@RequiredArgsConstructor
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
@Tag(name = "Courier Tracking Management", description = "API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è")
public class CourierTrackingManagementController {

    private final PublicTrackingService publicTrackingService;

    @Value("${app.frontend.url:https://coube.kz}")
    private String frontendUrl;

    @PostMapping("/transportations/{transportationId}/generate-link")
    @Operation(summary = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞")
    public ResponseEntity<GenerateTrackingLinkResponse> generateTrackingLink(
        @PathVariable Long transportationId
    ) {
        String token = publicTrackingService.generateOrGetTrackingToken(transportationId);
        String trackingUrl = frontendUrl + "/tracking/" + token;

        GenerateTrackingLinkResponse response = GenerateTrackingLinkResponse.builder()
            .transportationId(transportationId)
            .trackingToken(token)
            .trackingUrl(trackingUrl)
            .qrCodeUrl(null) // TODO: –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞
            .build();

        return ResponseEntity.ok(response);
    }
}
```

---

### 7. Service: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ `TransportationService`

**File:** `coube-backend/src/main/java/kz/coube/backend/applications/TransportationService.java`

```java
@Service
public class TransportationService {

    // ... existing methods

    /**
     * –ù–∞–π—Ç–∏ transportation –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
     */
    public Optional<Transportation> findByPublicTrackingToken(UUID token) {
        return transportationRepository.findByPublicTrackingToken(token);
    }
}
```

---

### 8. Security: Rate Limiting –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

**File:** `coube-backend/src/main/java/kz/coube/backend/config/RateLimitingConfig.java`

```java
package kz.coube.backend.config;

import io.github.bucket4j.Bandwidth;
import io.github.bucket4j.Bucket;
import io.github.bucket4j.Refill;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.time.Duration;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Configuration
public class RateLimitingConfig {

    private final Map<String, Bucket> cache = new ConcurrentHashMap<>();

    /**
     * Rate limiter –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ tracking API
     * –õ–∏–º–∏—Ç: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP –∞–¥—Ä–µ—Å
     */
    public Bucket resolveBucket(String key) {
        return cache.computeIfAbsent(key, k -> createNewBucket());
    }

    private Bucket createNewBucket() {
        Bandwidth limit = Bandwidth.classic(100, Refill.intervally(100, Duration.ofMinutes(1)));
        return Bucket.builder()
            .addLimit(limit)
            .build();
    }
}
```

**File:** `coube-backend/src/main/java/kz/coube/backend/config/RateLimitInterceptor.java`

```java
package kz.coube.backend.config;

import io.github.bucket4j.Bucket;
import io.github.bucket4j.ConsumptionProbe;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

@Component
@RequiredArgsConstructor
@Slf4j
public class RateLimitInterceptor implements HandlerInterceptor {

    private final RateLimitingConfig rateLimitingConfig;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String key = getClientIP(request);
        Bucket bucket = rateLimitingConfig.resolveBucket(key);
        ConsumptionProbe probe = bucket.tryConsumeAndReturnRemaining(1);

        if (probe.isConsumed()) {
            response.addHeader("X-Rate-Limit-Remaining", String.valueOf(probe.getRemainingTokens()));
            return true;
        } else {
            long waitForRefill = probe.getNanosToWaitForRefill() / 1_000_000_000;
            response.addHeader("X-Rate-Limit-Retry-After-Seconds", String.valueOf(waitForRefill));
            response.sendError(HttpStatus.TOO_MANY_REQUESTS.value(), "Too many requests. Please try again later.");
            return false;
        }
    }

    private String getClientIP(HttpServletRequest request) {
        String xfHeader = request.getHeader("X-Forwarded-For");
        if (xfHeader == null) {
            return request.getRemoteAddr();
        }
        return xfHeader.split(",")[0];
    }
}
```

**File:** `coube-backend/src/main/java/kz/coube/backend/config/WebMvcConfig.java`

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Autowired
    private RateLimitInterceptor rateLimitInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(rateLimitInterceptor)
            .addPathPatterns("/api/v1/public/**"); // –¢–æ–ª—å–∫–æ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö endpoints
    }
}
```

---

## üé® Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**File:** `coube-frontend/src/pages/PublicTrackingPage.vue`

```vue
<template>
  <div class="public-tracking-page">
    <!-- Header -->
    <header class="tracking-header">
      <div class="container">
        <img src="@/assets/logo.png" alt="Coube" class="logo" />
        <h1>{{ $t('tracking.title') }}</h1>
      </div>
    </header>

    <!-- Loading -->
    <div v-if="loading" class="loading-container">
      <LoadingSpinner />
      <p>{{ $t('tracking.loading') }}</p>
    </div>

    <!-- Error -->
    <div v-else-if="error" class="error-container">
      <ErrorIcon />
      <h2>{{ $t('tracking.error.title') }}</h2>
      <p>{{ error }}</p>
    </div>

    <!-- Content -->
    <div v-else class="tracking-content">
      <!-- Map -->
      <div class="map-container">
        <YandexMap
          :courier-location="trackingData.courierLocation"
          :route-points="trackingData.routePoints"
          :zoom="12"
        />
      </div>

      <!-- Info Panel -->
      <div class="info-panel">
        <!-- Status -->
        <div class="status-card">
          <StatusIcon :status="trackingData.status" />
          <h2>{{ trackingData.statusDescription }}</h2>
          <p v-if="trackingData.eta" class="eta">
            {{ $t('tracking.eta') }}: {{ formatETA(trackingData.eta) }}
          </p>
        </div>

        <!-- Courier Info -->
        <div class="courier-card">
          <h3>{{ $t('tracking.courier') }}</h3>
          <div class="courier-details">
            <UserIcon />
            <div>
              <p class="name">{{ trackingData.courierInfo.fullName }}</p>
              <a
                v-if="trackingData.courierInfo.phone"
                :href="`tel:${trackingData.courierInfo.phone}`"
                class="phone"
              >
                <PhoneIcon />
                {{ trackingData.courierInfo.phone }}
              </a>
            </div>
          </div>
        </div>

        <!-- Progress -->
        <div class="progress-card">
          <h3>{{ $t('tracking.progress') }}</h3>
          <div class="progress-bar">
            <div
              class="progress-fill"
              :style="{ width: progressPercentage + '%' }"
            ></div>
          </div>
          <p>
            {{ trackingData.progress.completedPoints }} /
            {{ trackingData.progress.totalPoints }}
            {{ $t('tracking.pointsCompleted') }}
          </p>
        </div>

        <!-- Route Points -->
        <div class="route-points-card">
          <h3>{{ $t('tracking.routePoints') }}</h3>
          <ul class="route-list">
            <li
              v-for="point in trackingData.routePoints"
              :key="point.orderNum"
              :class="{
                completed: point.isCompleted,
                current: point.isCurrentPoint,
              }"
            >
              <span class="point-number">{{ point.orderNum }}</span>
              <div class="point-info">
                <p class="address">{{ point.address }}</p>
                <p v-if="point.contactName" class="contact">
                  {{ point.contactName }}
                </p>
              </div>
              <CheckIcon v-if="point.isCompleted" class="check-icon" />
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useRoute } from 'vue-router'
import { useI18n } from 'vue-i18n'
import { getPublicTracking } from '@/api/publicTracking'
import type { PublicTrackingResponse } from '@/types/tracking'

const route = useRoute()
const { t } = useI18n()

const token = route.params.token as string
const trackingData = ref<PublicTrackingResponse | null>(null)
const loading = ref(true)
const error = ref<string | null>(null)
let pollingInterval: number | null = null

const progressPercentage = computed(() => {
  if (!trackingData.value) return 0
  const { completedPoints, totalPoints } = trackingData.value.progress
  return (completedPoints / totalPoints) * 100
})

const fetchTrackingData = async () => {
  try {
    const data = await getPublicTracking(token)
    trackingData.value = data
    error.value = null
  } catch (err: any) {
    error.value = err.message || t('tracking.error.default')
  } finally {
    loading.value = false
  }
}

const formatETA = (eta: string) => {
  const date = new Date(eta)
  return date.toLocaleTimeString('ru-RU', {
    hour: '2-digit',
    minute: '2-digit',
  })
}

onMounted(() => {
  // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  fetchTrackingData()

  // Polling –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
  pollingInterval = window.setInterval(fetchTrackingData, 15000)
})

onUnmounted(() => {
  if (pollingInterval) {
    clearInterval(pollingInterval)
  }
})
</script>

<style scoped lang="scss">
.public-tracking-page {
  min-height: 100vh;
  background: #f5f5f5;
}

.tracking-header {
  background: white;
  padding: 1rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;

    .logo {
      height: 40px;
    }
  }
}

.tracking-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  padding: 1rem;
  max-width: 1400px;
  margin: 0 auto;

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
}

.map-container {
  height: calc(100vh - 120px);
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.info-panel {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  overflow-y: auto;
  height: calc(100vh - 120px);

  > div {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
}

.courier-card {
  .courier-details {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;

    .name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .phone {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #007bff;
      text-decoration: none;
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      border: 1px solid #007bff;
      border-radius: 4px;
      margin-top: 0.5rem;

      &:hover {
        background: #007bff;
        color: white;
      }
    }
  }
}

.progress-card {
  .progress-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 1rem 0;

    .progress-fill {
      height: 100%;
      background: #4caf50;
      transition: width 0.3s ease;
    }
  }
}

.route-list {
  list-style: none;
  padding: 0;
  margin: 0;

  li {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-left: 3px solid #e0e0e0;
    margin-bottom: 0.5rem;

    &.completed {
      border-color: #4caf50;
      opacity: 0.7;
    }

    &.current {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .point-number {
      font-weight: 600;
      font-size: 1.2rem;
      min-width: 30px;
    }

    .point-info {
      flex: 1;

      .address {
        font-weight: 500;
      }

      .contact {
        color: #666;
        font-size: 0.9rem;
      }
    }

    .check-icon {
      color: #4caf50;
    }
  }
}
</style>
```

---

### 2. API –∫–ª–∏–µ–Ω—Ç

**File:** `coube-frontend/src/api/publicTracking.ts`

```typescript
import axios from 'axios'
import type { PublicTrackingResponse } from '@/types/tracking'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'https://api.coube.kz'

/**
 * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (–ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
 */
export const getPublicTracking = async (
  token: string
): Promise<PublicTrackingResponse> => {
  const response = await axios.get(
    `${API_BASE_URL}/api/v1/public/tracking/${token}`
  )
  return response.data
}

/**
 * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (–¥–ª—è –ª–æ–≥–∏—Å—Ç–∞, —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)
 */
export const generateTrackingLink = async (
  transportationId: number
): Promise<{ trackingUrl: string; trackingToken: string }> => {
  const response = await axios.post(
    `${API_BASE_URL}/api/v1/courier/tracking/transportations/${transportationId}/generate-link`,
    {},
    {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    }
  )
  return response.data
}
```

---

### 3. –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π" –≤ –¥–µ—Ç–∞–ª—è—Ö –∑–∞—è–≤–∫–∏ (–¥–ª—è –ª–æ–≥–∏—Å—Ç–∞)

**File:** `coube-frontend/src/components/TransportationDetails.vue`

```vue
<template>
  <div class="transportation-details">
    <!-- Existing content -->

    <!-- Share Tracking Link Button -->
    <button
      v-if="transportation.transportationType === 'COURIER_DELIVERY'"
      @click="shareTrackingLink"
      class="btn btn-primary"
    >
      <ShareIcon />
      {{ $t('transportation.shareTrackingLink') }}
    </button>

    <!-- Modal with tracking link -->
    <Modal v-if="showTrackingModal" @close="showTrackingModal = false">
      <h2>{{ $t('transportation.trackingLink') }}</h2>
      <div class="tracking-link-content">
        <input
          ref="linkInput"
          :value="trackingUrl"
          readonly
          class="tracking-input"
        />
        <button @click="copyToClipboard" class="btn btn-secondary">
          <CopyIcon />
          {{ $t('common.copy') }}
        </button>
      </div>
      <p class="hint">{{ $t('transportation.shareHint') }}</p>
    </Modal>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useI18n } from 'vue-i18n'
import { generateTrackingLink } from '@/api/publicTracking'
import { useNotification } from '@/composables/useNotification'

const props = defineProps<{
  transportation: Transportation
}>()

const { t } = useI18n()
const { showSuccess, showError } = useNotification()

const showTrackingModal = ref(false)
const trackingUrl = ref('')
const linkInput = ref<HTMLInputElement | null>(null)

const shareTrackingLink = async () => {
  try {
    const response = await generateTrackingLink(props.transportation.id)
    trackingUrl.value = response.trackingUrl
    showTrackingModal.value = true
  } catch (error) {
    showError(t('transportation.error.generateLink'))
  }
}

const copyToClipboard = () => {
  if (linkInput.value) {
    linkInput.value.select()
    document.execCommand('copy')
    showSuccess(t('common.copiedToClipboard'))
  }
}
</script>
```

---

## üß™ Testing Checklist

### Backend Tests

- [ ] `PublicTrackingService.generateOrGetTrackingToken()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
- [ ] `PublicTrackingService.getTrackingData()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–æ–∫–µ–Ω—É
- [ ] Public API endpoint `/api/v1/public/tracking/{token}` - –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- [ ] Rate limiting - 100 req/min –Ω–∞ IP
- [ ] Invalid token ‚Üí 404 Not Found
- [ ] Expired token (–µ—Å–ª–∏ TTL —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
- [ ] –¢–æ–ª—å–∫–æ COURIER_DELIVERY –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã

### Frontend Tests

- [ ] –ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/tracking/{token}` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- [ ] –ö–∞—Ä—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –ø–æ–∑–∏—Ü–∏–µ–π –∫—É—Ä—å–µ—Ä–∞
- [ ] –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫—É—Ä—å–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] Polling –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- [ ] –ö–Ω–æ–ø–∫–∞ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
- [ ] Responsive –¥–∏–∑–∞–π–Ω (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

### Integration Tests

- [ ] E2E: –õ–æ–≥–∏—Å—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É ‚Üí –∑–∞–∫–∞–∑—á–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç ‚Üí –≤–∏–¥–∏—Ç –∫—É—Ä—å–µ—Ä–∞
- [ ] –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ real-time

---

## üìä Example Request/Response

### Request 1: –õ–æ–≥–∏—Å—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É

```http
POST /api/v1/courier/tracking/transportations/12345/generate-link
Authorization: Bearer {logist-token}
```

**Response:**
```json
{
  "transportationId": 12345,
  "trackingToken": "550e8400-e29b-41d4-a716-446655440000",
  "trackingUrl": "https://coube.kz/tracking/550e8400-e29b-41d4-a716-446655440000",
  "qrCodeUrl": null
}
```

---

### Request 2: –ó–∞–∫–∞–∑—á–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É (–ø—É–±–ª–∏—á–Ω—ã–π API)

```http
GET /api/v1/public/tracking/550e8400-e29b-41d4-a716-446655440000
```

**Response:**
```json
{
  "transportationId": 12345,
  "status": "ON_THE_WAY",
  "statusDescription": "–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏",
  "courierLocation": {
    "latitude": 51.1605,
    "longitude": 71.4704,
    "timestamp": "2025-11-10T14:30:00Z"
  },
  "courierInfo": {
    "fullName": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
    "phone": "+77012345678"
  },
  "routePoints": [
    {
      "orderNum": 1,
      "address": "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞ 1",
      "contactName": "–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä",
      "contactPhone": "+77012345679",
      "isCompleted": true,
      "isCurrentPoint": false,
      "orderCount": 2
    },
    {
      "orderNum": 2,
      "address": "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –î–æ—Å—Ç—ã–∫ 5",
      "contactName": "–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä",
      "contactPhone": "+77012345680",
      "isCompleted": false,
      "isCurrentPoint": true,
      "orderCount": 1
    },
    {
      "orderNum": 3,
      "address": "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –ê–±–∞—è 10",
      "contactName": "–ö–∞–∑–∞—Ö–æ–≤ –ö–∞–∑–∞—Ö",
      "contactPhone": "+77012345681",
      "isCompleted": false,
      "isCurrentPoint": false,
      "orderCount": 3
    }
  ],
  "progress": {
    "totalPoints": 3,
    "completedPoints": 1,
    "currentPoint": 2
  },
  "eta": "2025-11-10T15:00:00Z",
  "createdAt": "2025-11-10T10:00:00Z"
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Rate Limiting**: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP –∞–¥—Ä–µ—Å
2. **–ú–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö**: –¢–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–±–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, —Ü–µ–Ω, –∏ —Ç.–¥.)
3. **TTL —Ç–æ–∫–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**: –¢–æ–∫–µ–Ω –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ 48 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
4. **CORS**: –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É API

---

## üìù Notes

1. **Polling vs WebSocket**: –í MVP –∏—Å–ø–æ–ª—å–∑—É–µ–º polling (–∫–∞–∂–¥—ã–µ 15 —Å–µ–∫). –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è real-time
2. **ETA —Ä–∞—Å—á–µ—Ç**: –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ (+30 –º–∏–Ω). –ù—É–∂–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Maps API –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
3. **QR-–∫–æ–¥**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —à–µ—Ä–∏–Ω–≥–∞
4. **TTL —Ç–æ–∫–µ–Ω–∞**: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ N —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑—á–∏–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

---

## üîó References

- **Similar features**: Uber tracking, Yandex.Taxi tracking, DHL tracking
- **Maps API**: Yandex Maps JavaScript API
- **Rate limiting**: Bucket4j library

---

**Estimated**: 3-4 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + 1 –¥–µ–Ω—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
**Priority**: MEDIUM (nice-to-have feature, —É–ª—É—á—à–∞–µ—Ç UX –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞)
