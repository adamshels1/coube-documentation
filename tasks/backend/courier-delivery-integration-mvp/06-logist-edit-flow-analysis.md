# 06. –ê–Ω–∞–ª–∏–∑ —Ñ–ª–æ—É: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤ –ª–æ–≥–∏—Å—Ç–æ–º

## üéØ –§–ª–æ—É –∏–∑ –¢–ó

–°–æ–≥–ª–∞—Å–Ω–æ –¢–ó "–ü—Ä–æ–µ–∫—Ç —Ä–µ—à–µ–Ω–∏—è Coube-Teez.md":

### –®–∞–≥ 1: TEEZ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç —á–µ—Ä–µ–∑ API
```
TEEZ_PVZ ‚Üí POST /api/v1/integration/waybills
–°—Ç–∞—Ç—É—Å: "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–µ–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫"
```

### –®–∞–≥ 2: –õ–æ–≥–∏—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Teez —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –≤ COUBE
**–¢–ó —Ü–∏—Ç–∞—Ç–∞**:
> "–ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç (–ú–õ) –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏—Å—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ (Teez). 
> –õ–æ–≥–∏—Å—Ç –¥–æ–ª–∂–µ–Ω –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –¥–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã COUBE."

**–õ–æ–≥–∏—Å—Ç –º–æ–∂–µ—Ç**:
- ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å —Ç–æ—á–∫–∏
- ‚úÖ –£–¥–∞–ª—è—Ç—å —Ç–æ—á–∫–∏
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å–∞ —Å –∫–∞—Ä—Ç–æ–π
- ‚úÖ –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Å—Ç–∞—Ç—É—Å "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" (–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫)

### –®–∞–≥ 3: –õ–æ–≥–∏—Å—Ç –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞
**–¢–ó —Ü–∏—Ç–∞—Ç–∞**:
> "–õ–æ–≥–∏—Å—Ç –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç"

### –®–∞–≥ 4: –ö—É—Ä—å–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É
(–≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)

### –®–∞–≥ 5: –õ–æ–≥–∏—Å—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–µ–∑–¥–∫—É
**–¢–ó —Ü–∏—Ç–∞—Ç–∞**:
> "–õ–æ–≥–∏—Å—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–µ–∑–¥–∫—É –≤ COUBE"

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –í MVP –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —ç—Ç–æ –ù–ï —É—á—Ç–µ–Ω–æ!

### –ß—Ç–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π MVP –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

1. ‚ùå **API –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞** - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. ‚ùå **–°—Ç–∞—Ç—É—Å "–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫"** - –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏—Å—Ç–æ–º
3. ‚ùå **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
4. ‚ùå **–†–æ–ª—å –ª–æ–≥–∏—Å—Ç–∞** - –∫—Ç–æ –∏–º–µ–Ω–Ω–æ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (LOGISTICIAN)
5. ‚ùå **–í–µ–± UI endpoints** - –¥–ª—è —Ä–∞–±–æ—Ç—ã –ª–æ–≥–∏—Å—Ç–∞ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º

### –ß—Ç–æ –µ—Å—Ç—å –≤ —Ç–µ–∫—É—â–µ–π MVP –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

‚úÖ –ò–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –æ—Ç TEEZ (API)  
‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ (–Ω–æ –Ω–µ –æ–ø–∏—Å–∞–Ω–æ –ö–¢–û –Ω–∞–∑–Ω–∞—á–∞–µ—Ç)  
‚úÖ –ú–æ–±–∏–ª—å–Ω–æ–µ API –¥–ª—è –∫—É—Ä—å–µ—Ä–∞  
‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ TEEZ  
‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞  

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–æ–ø–æ–ª–Ω–∏—Ç—å MVP —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –ª–æ–≥–∏—Å—Ç–∞

### 1. –°—Ç–∞—Ç—É—Å—ã –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ (—Ä–∞—Å—à–∏—Ä–∏—Ç—å)

–ò–∑ –¢–ó:
```
imported_draft       ‚Üí –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–µ–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
validated            ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫)
assigned             ‚Üí –ù–∞–∑–Ω–∞—á–µ–Ω –∫—É—Ä—å–µ—Ä
in_route             ‚Üí –ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏
completed            ‚Üí –ú–∞—Ä—à—Ä—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω
closed               ‚Üí –ó–∞–∫—Ä—ã—Ç –ª–æ–≥–∏—Å—Ç–æ–º
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –£–∂–µ –µ—Å—Ç—å –≤ `CourierValidationStatus` enum!

### 2. API –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞ (–î–û–ë–ê–í–ò–¢–¨ –≤ MVP!)

#### GET /api/v1/courier/waybills (—Å–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤)

**–†–æ–ª—å**: `LOGISTICIAN` (–ª–æ–≥–∏—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Teez)

```java
@GetMapping("/waybills")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<Page<CourierWaybillListResponse>> getWaybills(
    @RequestParam(required = false) String status,
    @RequestParam(required = false) String search,
    Pageable pageable) {
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ:
    // - status (imported_draft, validated, assigned, etc.)
    // - search (–ø–æ –≤–Ω–µ—à–Ω–µ–º—É ID, –Ω–æ–º–µ—Ä—É)
    // - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Å—Ç–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ RequestContext)
    
    return ResponseEntity.ok(courierWaybillService.getWaybills(status, search, pageable));
}
```

#### GET /api/v1/courier/waybills/{id} (–¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)

```java
@GetMapping("/waybills/{id}")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<CourierWaybillDetailResponse> getWaybillDetails(
    @PathVariable Long id) {
    
    Transportation waybill = courierWaybillService.getWaybillById(id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –ª–æ–≥–∏—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    if (!waybill.getExecutorOrganization().getId().equals(RequestContext.getOrganizationId())) {
        throw new AccessDeniedException("You don't have access to this waybill");
    }
    
    return ResponseEntity.ok(courierWaybillMapper.toDetailResponse(waybill));
}
```

#### PUT /api/v1/courier/waybills/{id} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞)

**–í–∞–∂–Ω–æ**: –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Å—Ç–∞—Ç—É—Å–µ `imported_draft`!

```java
@PutMapping("/waybills/{id}")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<CourierWaybillDetailResponse> updateWaybill(
    @PathVariable Long id,
    @Valid @RequestBody UpdateWaybillRequest request) {
    
    Transportation waybill = courierWaybillService.getWaybillById(id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ - –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–Ω–æ–≤–∏–∫
    if (!CourierValidationStatus.IMPORTED.equals(waybill.getCourierValidationStatus())) {
        throw new BusinessException("Can only edit waybills in IMPORTED status");
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
    courierWaybillService.updateWaybillPoints(id, request.getDeliveryPoints());
    
    return ResponseEntity.ok(courierWaybillMapper.toDetailResponse(waybill));
}
```

#### POST /api/v1/courier/waybills/{id}/validate (–≤–∞–ª–∏–¥–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞)

**–î–µ–π—Å—Ç–≤–∏–µ**: –ü–µ—Ä–µ–≤–æ–¥ –∏–∑ `imported_draft` ‚Üí `validated`

```java
@PostMapping("/waybills/{id}/validate")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<Void> validateWaybill(@PathVariable Long id) {
    
    Transportation waybill = courierWaybillService.getWaybillById(id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ - —Å–∫–ª–∞–¥
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ sort_order
    courierWaybillService.validateAndApprove(id);
    
    // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
    waybill.setCourierValidationStatus(CourierValidationStatus.VALIDATED);
    
    return ResponseEntity.ok().build();
}
```

#### POST /api/v1/courier/waybills/{id}/assign (–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞)

**–î–µ–π—Å—Ç–≤–∏–µ**: –ù–∞–∑–Ω–∞—á–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å `assigned`

```java
@PostMapping("/waybills/{id}/assign")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<Void> assignCourier(
    @PathVariable Long id,
    @RequestBody AssignCourierRequest request) {
    
    Transportation waybill = courierWaybillService.getWaybillById(id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
    if (!CourierValidationStatus.VALIDATED.equals(waybill.getCourierValidationStatus())) {
        throw new BusinessException("Waybill must be validated before assigning courier");
    }
    
    // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –∏–∑ 05-courier-without-transport.md)
    executorService.assignCourierToTransportation(id, request.getCourierId());
    
    // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
    waybill.setCourierValidationStatus(CourierValidationStatus.ASSIGNED);
    waybill.setStatus(TransportationStatus.WAITING_DRIVER_CONFIRMATION);
    
    return ResponseEntity.ok().build();
}
```

#### POST /api/v1/courier/waybills/{id}/close (–∑–∞–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞)

**–î–µ–π—Å—Ç–≤–∏–µ**: –õ–æ–≥–∏—Å—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```java
@PostMapping("/waybills/{id}/close")
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN})
public ResponseEntity<Void> closeWaybill(@PathVariable Long id) {
    
    Transportation waybill = courierWaybillService.getWaybillById(id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω
    if (!TransportationStatus.FINISHED.equals(waybill.getStatus())) {
        throw new BusinessException("Can only close finished waybills");
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
    waybill.setCourierValidationStatus(CourierValidationStatus.CLOSED);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ TEEZ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)
    courierResultsService.sendResultsSync(id);
    
    return ResponseEntity.ok().build();
}
```

### 3. DTO –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞

```java
// Response –¥–ª—è —Å–ø–∏—Å–∫–∞
@Data @Builder
public class CourierWaybillListResponse {
    private Long id;
    private String externalWaybillId;
    private String sourceSystem;
    private CourierValidationStatus validationStatus;
    private TransportationStatus status;
    private Integer pointsCount;
    private Integer ordersCount;
    private String courierName; // –µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω
    private LocalDate targetDeliveryDay;
    private Instant createdAt;
}

// Response –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
@Data @Builder
public class CourierWaybillDetailResponse {
    private Long id;
    private String externalWaybillId;
    private String sourceSystem;
    private CourierValidationStatus validationStatus;
    private TransportationStatus status;
    
    private CourierInfo courier; // –µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω
    private List<RoutePointInfo> routePoints;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    private Integer totalPoints;
    private Integer totalOrders;
    private Integer deliveredOrders;
    private Integer returnedOrders;
    
    private Instant createdAt;
    private Instant updatedAt;
}

// Request –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
@Data
public class UpdateWaybillRequest {
    private List<DeliveryPointUpdateDto> deliveryPoints;
}

// Request –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
@Data
public class AssignCourierRequest {
    private Long courierId;
}
```

### 4. CourierWaybillService (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å)

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class CourierWaybillService {
    
    private final TransportationRepository transportationRepo;
    private final EmployeeService employeeService;
    private final TransportationRouteService routeService;
    
    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞
     */
    @Transactional(readOnly = true)
    public Page<CourierWaybillListResponse> getWaybills(
            String status, 
            String search, 
            Pageable pageable) {
        
        Long organizationId = RequestContext.getOrganizationId();
        
        // Specification –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        Specification<Transportation> spec = (root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();
            
            // –¢–æ–ª—å–∫–æ COURIER_DELIVERY
            predicates.add(cb.equal(root.get("transportationType"), 
                                   TransportationType.COURIER_DELIVERY));
            
            // –¢–æ–ª—å–∫–æ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏—Å—Ç–∞
            predicates.add(cb.equal(root.get("executorOrganization").get("id"), 
                                   organizationId));
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (status != null) {
                predicates.add(cb.equal(root.get("courierValidationStatus"), 
                                       CourierValidationStatus.valueOf(status)));
            }
            
            // –ü–æ–∏—Å–∫
            if (search != null && !search.isBlank()) {
                predicates.add(cb.or(
                    cb.like(root.get("externalWaybillId"), "%" + search + "%"),
                    cb.like(root.get("id").as(String.class), "%" + search + "%")
                ));
            }
            
            return cb.and(predicates.toArray(new Predicate[0]));
        };
        
        return transportationRepo.findAll(spec, pageable)
            .map(this::toListResponse);
    }
    
    /**
     * –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–≤–æ–¥ –≤ —Å—Ç–∞—Ç—É—Å VALIDATED
     */
    @Transactional
    public void validateAndApprove(Long waybillId) {
        Transportation waybill = transportationRepo.findById(waybillId)
            .orElseThrow(() -> new NotFoundException("Waybill not found"));
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        if (!CourierValidationStatus.IMPORTED.equals(waybill.getCourierValidationStatus())) {
            throw new BusinessException("Can only validate waybills in IMPORTED status");
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏–∏
        List<CargoLoadingHistory> points = waybill.getCargoLoadings();
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ sort_order
        Set<Integer> sortOrders = points.stream()
            .map(CargoLoadingHistory::getOrderNum)
            .collect(Collectors.toSet());
        if (sortOrders.size() != points.size()) {
            throw new ValidationException("Duplicate sort orders found");
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ - —Å–∫–ª–∞–¥
        CargoLoadingHistory lastPoint = points.stream()
            .max(Comparator.comparing(CargoLoadingHistory::getOrderNum))
            .orElseThrow(() -> new ValidationException("No route points"));
        if (lastPoint.getCourierWarehouseId() == null) {
            throw new ValidationException("Last point must be a warehouse");
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã
        boolean hasUngeoc codedPoints = points.stream()
            .anyMatch(p -> p.getLocation() == null && p.getCourierWarehouseId() == null);
        if (hasUngeocodedPoints) {
            throw new ValidationException("All addresses must be geocoded");
        }
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å—Ç–∞—Ç—É—Å VALIDATED
        waybill.setCourierValidationStatus(CourierValidationStatus.VALIDATED);
        transportationRepo.save(waybill);
        
        log.info("Waybill {} validated by logist", waybillId);
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (—Ç–æ–ª—å–∫–æ –≤ —Å—Ç–∞—Ç—É—Å–µ IMPORTED)
     */
    @Transactional
    public void updateWaybillPoints(Long waybillId, List<DeliveryPointUpdateDto> points) {
        Transportation waybill = transportationRepo.findById(waybillId)
            .orElseThrow(() -> new NotFoundException("Waybill not found"));
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        if (!CourierValidationStatus.IMPORTED.equals(waybill.getCourierValidationStatus())) {
            throw new BusinessException("Can only edit waybills in IMPORTED status");
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TransportationRouteService
        // (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª!)
        routeService.updateRoute(waybill, points);
        
        log.info("Waybill {} points updated by logist", waybillId);
    }
    
    // Helper methods...
}
```

---

## üìã –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç MVP

### –î–æ–±–∞–≤–∏—Ç—å –≤ Week 2-3:

**–ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- [ ] `CourierWaybillService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–Ω—ã–º–∏ –ª–∏—Å—Ç–∞–º–∏ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞
- [ ] `CourierWaybillController` - REST API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ª–æ–≥–∏—Å—Ç–∞
- [ ] DTOs –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞ (3-4 –∫–ª–∞—Å—Å–∞)

**–ù–æ–≤—ã–µ endpoints** (5 —à—Ç):
- [ ] `GET /api/v1/courier/waybills` - —Å–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤
- [ ] `GET /api/v1/courier/waybills/{id}` - –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
- [ ] `PUT /api/v1/courier/waybills/{id}` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
- [ ] `POST /api/v1/courier/waybills/{id}/validate` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
- [ ] `POST /api/v1/courier/waybills/{id}/close` - –∑–∞–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º**:
- ‚úÖ `POST /executor/{id}/assign-courier` - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `05-courier-without-transport.md`

---

## üéØ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π)

```
1. TEEZ ‚Üí POST /api/v1/integration/waybills
   Status: IMPORTED (imported_draft)

2. –õ–æ–≥–∏—Å—Ç (—á–µ—Ä–µ–∑ –≤–µ–±) ‚Üí GET /api/v1/courier/waybills
   –í–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤

3. –õ–æ–≥–∏—Å—Ç ‚Üí GET /api/v1/courier/waybills/{id}
   –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞

4. –õ–æ–≥–∏—Å—Ç ‚Üí PUT /api/v1/courier/waybills/{id}
   –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç/—É–¥–∞–ª—è–µ—Ç/–∏–∑–º–µ–Ω—è–µ—Ç)
   –°—Ç–∞—Ç—É—Å: IMPORTED (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)

5. –õ–æ–≥–∏—Å—Ç ‚Üí POST /api/v1/courier/waybills/{id}/validate
   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç
   Status: IMPORTED ‚Üí VALIDATED

6. –õ–æ–≥–∏—Å—Ç ‚Üí POST /api/v1/courier/waybills/{id}/assign
   –ù–∞–∑–Ω–∞—á–∞–µ—Ç –∫—É—Ä—å–µ—Ä–∞
   Status: VALIDATED ‚Üí ASSIGNED
   TransportationStatus: WAITING_DRIVER_CONFIRMATION

7. –ö—É—Ä—å–µ—Ä (–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É
   (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DriverController)
   Status: ASSIGNED ‚Üí IN_ROUTE ‚Üí COMPLETED
   TransportationStatus: DRIVER_ACCEPTED ‚Üí ON_THE_WAY ‚Üí FINISHED

8. –õ–æ–≥–∏—Å—Ç ‚Üí POST /api/v1/courier/waybills/{id}/close
   –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç
   Status: COMPLETED ‚Üí CLOSED
   ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ TEEZ

9. Coube ‚Üí POST {teez_api_url}/api/waybill/results
   –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

---

## ‚úÖ –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ MVP –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

1. **01-mvp-plan.md**: –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "API –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞" —Å endpoints
2. **02-implementation-checklist.md**: –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª 2.X "–õ–æ–≥–∏—Å—Ç Web API"
3. **03-api-examples.md**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞
4. **–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç (06)**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–ª–æ—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ª–æ–≥–∏—Å—Ç–∞**:
- `CourierWaybillService`: 4-6 —á–∞—Å–æ–≤
- `CourierWaybillController` + DTOs: 3-4 —á–∞—Å–∞
- –¢–µ—Å—Ç—ã: 2-3 —á–∞—Å–∞
- **–ò—Ç–æ–≥–æ: +9-13 —á–∞—Å–æ–≤ (1-1.5 –¥–Ω—è)**

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ MVP**: 2.5-3.5 –Ω–µ–¥–µ–ª–∏ (–≤–º–µ—Å—Ç–æ 2-3)

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ –£–ñ–ï —É—á—Ç–µ–Ω–æ –≤ MVP:
- –ò–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –æ—Ç TEEZ
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ (–Ω–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ö–¢–û –Ω–∞–∑–Ω–∞—á–∞–µ—Ç)
- –ú–æ–±–∏–ª—å–Ω–æ–µ API –¥–ª—è –∫—É—Ä—å–µ—Ä–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ TEEZ
- –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞

### ‚ùå –ß—Ç–æ –ü–†–û–ü–£–©–ï–ù–û –∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- **API –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞** - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
- **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞** - –ø–µ—Ä–µ–≤–æ–¥ –≤ —Å—Ç–∞—Ç—É—Å "–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω"
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
- **–†–æ–ª—å LOGISTICIAN** - –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É

### üéØ –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å **5 –Ω–æ–≤—ã—Ö endpoints** –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞ + `CourierWaybillService` (–ø—Ä–∏–º–µ—Ä–Ω–æ 1-1.5 –¥–Ω—è —Ä–∞–±–æ—Ç—ã)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-07  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: HIGH (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –¢–ó)
