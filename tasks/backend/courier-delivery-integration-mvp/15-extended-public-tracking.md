# 15. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞—è–≤–æ–∫

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-12-04
**–°—Ç–∞—Ç—É—Å**: TO DO
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: MEDIUM
**–ê–≤—Ç–æ—Ä**: Ali (Product Requirements)

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–ë–∏–∑–Ω–µ—Å-–∫–µ–π—Å:**
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (COURIER_DELIVERY). –ó–∞–∫–∞–∑—á–∏–∫–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –ø–µ—Ä–µ–≤–æ–∑–æ–∫ —Ç–∞–∫–∂–µ —Ö–æ—Ç—è—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ –≥—Ä—É–∑—ã:
- FTL (–º–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏) - –∫—Ä—É–ø–Ω—ã–µ –≥—Ä—É–∑—ã –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏
- LTL (—Å–±–æ—Ä–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏) - —á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
- CITY (–≥–æ—Ä–æ–¥—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏) - –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É
- BULK (—Å—ã–ø—É—á–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã) - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏

**–¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
1. PublicTrackingService –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å COURIER_DELIVERY
2. –í RoutePoint –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (latitude/longitude), —Ö–æ—Ç—è –æ–Ω–∏ –µ—Å—Ç—å –≤ –ë–î
3. FTL-–∑–∞—è–≤–∫–∏ –Ω–µ –º–æ–≥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
4. –ù–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
–†–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞.

---

## üéØ –†–µ—à–µ–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏**
   - –£–±—Ä–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ COURIER_DELIVERY
   - –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞—è–≤–æ–∫

2. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ RoutePoint**
   - –î–æ–±–∞–≤–∏—Ç—å latitude/longitude –≤ RoutePoint DTO
   - –ò–∑–≤–ª–µ–∫–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ CargoLoadingHistory.location

3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
   - –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç ETA –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

---

## üóÑÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –≥–æ—Ç–æ–≤–∞ - –Ω–∏–∫–∞–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è:
- –ü–æ–ª–µ `public_tracking_token` —É–∂–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ `transportation`
- –ü–æ–ª–µ `location` —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —É–∂–µ –µ—Å—Ç—å –≤ `cargo_loading_history`

---

## üîß Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–∏—Ç—å PublicTrackingService

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/service/PublicTrackingService.java`

```java
package kz.coube.backend.courier.service;

import kz.coube.backend.applications.TransportationService;
import kz.coube.backend.applications.entity.CourierRouteOrder;
import kz.coube.backend.applications.entity.Transportation;
import kz.coube.backend.courier.dto.PublicTrackingResponse;
import kz.coube.backend.dictionaries.enumeration.TransportationType;
import kz.coube.backend.driver.DriverLocationService;
import kz.coube.backend.driver.model.DriverLocation;
import kz.coube.backend.organization.model.Employee;
import kz.coube.backend.route.entity.CargoLoadingHistory;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class PublicTrackingService {

    private final TransportationService transportationService;
    private final CourierRouteOrderService courierRouteOrderService;
    private final DriverLocationService driverLocationService;

    // –¢–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –ø—É–±–ª–∏—á–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥
    private static final Set<TransportationType> SUPPORTED_TYPES = Set.of(
        TransportationType.COURIER_DELIVERY,
        TransportationType.FTL,
        TransportationType.LTL,
        TransportationType.CITY,
        TransportationType.BULK
    );

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è transportation
     * –¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
     */
    @Transactional
    public String generateOrGetTrackingToken(Long transportationId) {
        Transportation transportation = transportationService.findById(transportationId);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∏–ø–æ–≤ (–ø–æ —Ñ–∞–∫—Ç—É - –≤—Å–µ —Ç–∏–ø—ã)
        if (!SUPPORTED_TYPES.contains(transportation.getTransportationType())) {
            throw new IllegalStateException(
                "Public tracking is not supported for transportation type: " +
                transportation.getTransportationType()
            );
        }

        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å - –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ
        if (transportation.getPublicTrackingToken() != null) {
            return transportation.getPublicTrackingToken().toString();
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
        UUID token = UUID.randomUUID();
        transportation.setPublicTrackingToken(token);
        transportationService.save(transportation);

        log.info("Generated public tracking token for {} transportation {}: {}",
                 transportation.getTransportationType(), transportationId, token);

        return token.toString();
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (–ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
     * –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
     */
    @Transactional(readOnly = true)
    public PublicTrackingResponse getTrackingData(UUID token) {

        Transportation transportation = transportationService
                .getByPublicTrackingToken(token);

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        PublicTrackingResponse.CourierLocation location = null;
        List<DriverLocation> driverLocationResponses =
            driverLocationService.getDriverLocationsByTransportationId(transportation.getId());

        if (!driverLocationResponses.isEmpty()) {
            DriverLocation latestLocation = driverLocationResponses.stream()
                    .max(Comparator.comparing(DriverLocation::getTimestamp))
                    .orElse(null);
            if (latestLocation != null) {
                location = PublicTrackingResponse.CourierLocation.builder()
                        .latitude(latestLocation.getLocation().getY())
                        .longitude(latestLocation.getLocation().getX())
                        .timestamp(latestLocation.getTimestamp())
                        .build();
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–¥–∏—Ç–µ–ª–µ/–∫—É—Ä—å–µ—Ä–µ
        PublicTrackingResponse.CourierInfo courierInfo = getCourierInfo(transportation);

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        List<PublicTrackingResponse.RoutePoint> routePoints = getRoutePoints(transportation);

        // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        PublicTrackingResponse.Progress progress = calculateProgress(transportation);

        // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ETA (—Å —É—á–µ—Ç–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞)
        LocalDateTime eta = calculateETA(transportation, location, routePoints);

        // –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        String transportationTypeDescription = getTransportationTypeDescription(
            transportation.getTransportationType()
        );

        return PublicTrackingResponse.builder()
                .transportationId(transportation.getId())
                .transportationType(transportation.getTransportationType().name())
                .transportationTypeDescription(transportationTypeDescription)
                .status(transportation.getStatus().name())
                .statusDescription(getStatusDescription(transportation.getStatus()))
                .courierLocation(location)
                .courierInfo(courierInfo)
                .routePoints(routePoints)
                .progress(progress)
                .eta(eta)
                .createdAt(transportation.getCreatedAt())
                .build();
    }

    private PublicTrackingResponse.CourierInfo getCourierInfo(Transportation transportation) {
        Employee driver = transportation.getExecutorEmployee();

        if (driver == null) {
            // –†–∞–∑–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            String noDriverMessage = switch (transportation.getTransportationType()) {
                case COURIER_DELIVERY -> "–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
                case FTL, LTL, CITY, BULK -> "–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
                default -> "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
            };

            return PublicTrackingResponse.CourierInfo.builder()
                    .fullName(noDriverMessage)
                    .phone(null)
                    .build();
        }

        return PublicTrackingResponse.CourierInfo.builder()
                .fullName(driver.getFullName())
                .phone(driver.getPhone())
                .build();
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
     */
    private List<PublicTrackingResponse.RoutePoint> getRoutePoints(Transportation transportation) {
        List<CargoLoadingHistory> cargoLoadings = transportation.getCargoLoadings();
        if (cargoLoadings == null || cargoLoadings.isEmpty()) {
            return List.of();
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        return cargoLoadings.stream()
                .filter(cl -> shouldIncludePoint(cl, transportation.getTransportationType()))
                .map(cl -> {
                    // –î–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã
                    Integer orderCount = null;
                    if (transportation.getTransportationType() == TransportationType.COURIER_DELIVERY) {
                        List<CourierRouteOrder> orders = courierRouteOrderService.getByCargoLoadingHistory(cl);
                        orderCount = orders.size();
                    }

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ location
                    Double latitude = null;
                    Double longitude = null;
                    if (cl.getLocation() != null) {
                        latitude = cl.getLocation().getY();
                        longitude = cl.getLocation().getX();
                    }

                    return PublicTrackingResponse.RoutePoint.builder()
                            .orderNum(cl.getOrderNum())
                            .address(cl.getAddress())
                            .contactName(cl.getContactPersonName())
                            .contactPhone(cl.getContactNumber())
                            .latitude(latitude)
                            .longitude(longitude)
                            .loadingType(cl.getLoadingType() != null ? cl.getLoadingType().name() : null)
                            .loadingDatetime(cl.getLoadingDatetime())
                            .weight(cl.getWeight())
                            .weightUnit(cl.getWeightUnit() != null ? cl.getWeightUnit().name() : null)
                            .volume(cl.getVolume())
                            .commentary(cl.getCommentary())
                            .isCompleted(cl.getIsActive() == null || !cl.getIsActive())
                            .isCurrentPoint(Boolean.TRUE.equals(cl.getIsActive()))
                            .isDriverAtLocation(cl.getIsDriverAtLocation())
                            .orderCount(orderCount)
                            .build();
                })
                .collect(Collectors.toList());
    }

    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –≤–∫–ª—é—á–∞—Ç—å —Ç–æ—á–∫—É –≤ –º–∞—Ä—à—Ä—É—Ç
     */
    private boolean shouldIncludePoint(CargoLoadingHistory cl, TransportationType type) {
        // –î–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ - —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏ —Å–æ —Å–∫–ª–∞–¥–∞–º–∏
        if (type == TransportationType.COURIER_DELIVERY) {
            return cl.getCourierWarehouseId() != null;
        }
        // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ - –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏
        return true;
    }

    private PublicTrackingResponse.Progress calculateProgress(Transportation transportation) {
        List<CargoLoadingHistory> cargoLoadings = transportation.getCargoLoadings();
        if (cargoLoadings == null || cargoLoadings.isEmpty()) {
            return PublicTrackingResponse.Progress.builder()
                    .totalPoints(0)
                    .completedPoints(0)
                    .currentPoint(0)
                    .percentage(0.0)
                    .build();
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        List<CargoLoadingHistory> relevantPoints = cargoLoadings.stream()
                .filter(cl -> shouldIncludePoint(cl, transportation.getTransportationType()))
                .toList();

        long completed = relevantPoints.stream()
                .filter(cl -> cl.getIsActive() == null || !cl.getIsActive())
                .count();

        int currentPoint = relevantPoints.stream()
                .filter(cl -> Boolean.TRUE.equals(cl.getIsActive()))
                .findFirst()
                .map(CargoLoadingHistory::getOrderNum)
                .orElse(relevantPoints.size());

        double percentage = relevantPoints.isEmpty() ? 0 :
                           (completed * 100.0) / relevantPoints.size();

        return PublicTrackingResponse.Progress.builder()
                .totalPoints(relevantPoints.size())
                .completedPoints((int) completed)
                .currentPoint(currentPoint)
                .percentage(percentage)
                .build();
    }

    /**
     * –†–∞—Å—á–µ—Ç ETA —Å —É—á–µ—Ç–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç–æ—á–µ–∫
     */
    private LocalDateTime calculateETA(Transportation transportation,
                                       PublicTrackingResponse.CourierLocation currentLocation,
                                       List<PublicTrackingResponse.RoutePoint> routePoints) {

        // –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é —Ç–æ—á–∫—É
        PublicTrackingResponse.RoutePoint activePoint = routePoints.stream()
                .filter(rp -> Boolean.TRUE.equals(rp.isCurrentPoint()))
                .findFirst()
                .orElse(null);

        if (activePoint == null) {
            return null; // –ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ —Ü–µ–ª–µ–≤–æ–π —Ç–æ—á–∫–∏
        if (currentLocation != null && activePoint.latitude() != null && activePoint.longitude() != null) {
            // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞)
            double distance = calculateDistance(
                currentLocation.latitude(), currentLocation.longitude(),
                activePoint.latitude(), activePoint.longitude()
            );

            // –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–∫–º/—á)
            double averageSpeed = switch (transportation.getTransportationType()) {
                case COURIER_DELIVERY, CITY -> 30.0; // –ì–æ—Ä–æ–¥—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
                case FTL, LTL -> 60.0; // –ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
                case BULK -> 40.0; // –°–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∏
                default -> 45.0;
            };

            // –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö = (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º) / (—Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∫–º/—á) * 60
            int estimatedMinutes = (int) ((distance / averageSpeed) * 60);

            // –î–æ–±–∞–≤–∏—Ç—å –±—É—Ñ–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø–æ–≥—Ä—É–∑–∫–∏/—Ä–∞–∑–≥—Ä—É–∑–∫–∏
            int bufferMinutes = switch (transportation.getTransportationType()) {
                case COURIER_DELIVERY -> 10;
                case CITY -> 15;
                case FTL, LTL, BULK -> 30;
                default -> 20;
            };

            return LocalDateTime.now().plusMinutes(estimatedMinutes + bufferMinutes);
        }

        // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
        return LocalDateTime.now().plusMinutes(30);
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞)
     * @return —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
     */
    private double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
        final int R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö

        double latDistance = Math.toRadians(lat2 - lat1);
        double lonDistance = Math.toRadians(lon2 - lon1);
        double a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)
                + Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))
                * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);
        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
    }

    private String getStatusDescription(kz.coube.backend.dictionaries.enumeration.TransportationStatus status) {
        return switch (status) {
            case DRIVER_ACCEPTED -> "–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑";
            case ON_THE_WAY -> "–í –ø—É—Ç–∏";
            case AWAITING_RETURN_CONFIRMATION -> "–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞";
            case FINISHED -> "–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
            case LOADING -> "–ü–æ–≥—Ä—É–∑–∫–∞";
            case UNLOADING -> "–†–∞–∑–≥—Ä—É–∑–∫–∞";
            default -> status.name();
        };
    }

    private String getTransportationTypeDescription(TransportationType type) {
        return switch (type) {
            case FTL -> "–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (FTL)";
            case LTL -> "–°–±–æ—Ä–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (LTL)";
            case CITY -> "–ì–æ—Ä–æ–¥—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏";
            case BULK -> "–ü–µ—Ä–µ–≤–æ–∑–∫–∞ —Å—ã–ø—É—á–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤";
            case COURIER_DELIVERY -> "–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞";
            default -> type.name();
        };
    }
}
```

---

### 2. –û–±–Ω–æ–≤–∏—Ç—å PublicTrackingResponse DTO

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/dto/PublicTrackingResponse.java`

```java
package kz.coube.backend.courier.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.Builder;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@Builder
@JsonInclude(JsonInclude.Include.NON_NULL)
public record PublicTrackingResponse(
        Long transportationId,
        String transportationType,
        String transportationTypeDescription,
        String status,
        String statusDescription,
        CourierLocation courierLocation,
        CourierInfo courierInfo,
        List<RoutePoint> routePoints,
        Progress progress,
        LocalDateTime eta,
        LocalDateTime createdAt
) {
    @Builder
    public record CourierLocation(
            Double latitude,
            Double longitude,
            LocalDateTime timestamp
    ) {}

    @Builder
    public record CourierInfo(
            String fullName,
            String phone
    ) {}

    @Builder
    public record RoutePoint(
            Integer orderNum,
            String address,
            String contactName,
            String contactPhone,
            Double latitude,  // NEW: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏
            Double longitude, // NEW: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏
            String loadingType, // NEW: —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∑–∞–≥—Ä—É–∑–∫–∞/—Ä–∞–∑–≥—Ä—É–∑–∫–∞)
            LocalDateTime loadingDatetime, // NEW: –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏
            BigDecimal weight, // NEW: –≤–µ—Å –≥—Ä—É–∑–∞ –≤ —Ç–æ—á–∫–µ
            String weightUnit, // NEW: –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤–µ—Å–∞
            BigDecimal volume, // NEW: –æ–±—ä–µ–º –≥—Ä—É–∑–∞
            String commentary, // NEW: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–æ—á–∫–µ
            Boolean isCompleted,
            Boolean isCurrentPoint,
            Boolean isDriverAtLocation, // NEW: –≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–±—ã–ª –Ω–∞ —Ç–æ—á–∫—É
            Integer orderCount // —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
    ) {}

    @Builder
    public record Progress(
            Integer totalPoints,
            Integer completedPoints,
            Integer currentPoint,
            Double percentage // NEW: –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    ) {}
}
```

---

### 3. –û–±–Ω–æ–≤–∏—Ç—å Controller –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤

**File:** `coube-backend/src/main/java/kz/coube/backend/courier/api/CourierTrackingManagementController.java`

```java
package kz.coube.backend.courier.api;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import kz.coube.backend.auth.annotations.AuthorizationRequired;
import kz.coube.backend.auth.roles.KeycloakRole;
import kz.coube.backend.courier.dto.GenerateTrackingLinkResponse;
import kz.coube.backend.courier.service.PublicTrackingService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/tracking/management") // –ò–∑–º–µ–Ω–µ–Ω –ø—É—Ç—å - –Ω–µ —Ç–æ–ª—å–∫–æ courier
@RequiredArgsConstructor
@AuthorizationRequired(roles = {KeycloakRole.LOGISTICIAN, KeycloakRole.ADMIN, KeycloakRole.CUSTOMER})
@Tag(name = "Tracking Management", description = "API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞—è–≤–æ–∫")
public class TrackingManagementController {

    private final PublicTrackingService publicTrackingService;

    @Value("${app.frontend.url:https://coube.kz}")
    private String frontendUrl;

    @PostMapping("/transportations/{transportationId}/generate-link")
    @Operation(
        summary = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
        description = "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥—Ä—É–∑–∞. " +
                      "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏: FTL, LTL, CITY, BULK, COURIER_DELIVERY"
    )
    public ResponseEntity<GenerateTrackingLinkResponse> generateTrackingLink(
        @PathVariable Long transportationId
    ) {
        String token = publicTrackingService.generateOrGetTrackingToken(transportationId);
        String trackingUrl = frontendUrl + "/tracking/" + token;

        GenerateTrackingLinkResponse response = GenerateTrackingLinkResponse.builder()
            .transportationId(transportationId)
            .trackingToken(token)
            .trackingUrl(trackingUrl)
            .qrCodeUrl(null) // TODO: –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞
            .build();

        return ResponseEntity.ok(response);
    }
}
```

---

## üé® Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–µ–∫–∏–Ω–≥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

**File:** `coube-frontend/src/components/tracking/RouteMap.vue`

```vue
<template>
  <div class="route-map">
    <YandexMap
      :center="mapCenter"
      :zoom="mapZoom"
      @ready="onMapReady"
    >
      <!-- –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ -->
      <YandexMarker
        v-if="courierLocation"
        :coordinates="[courierLocation.longitude, courierLocation.latitude]"
        :icon="vehicleIcon"
        :title="$t('tracking.currentPosition')"
      />

      <!-- –ú–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ -->
      <YandexMarker
        v-for="point in routePoints"
        :key="point.orderNum"
        :coordinates="[point.longitude, point.latitude]"
        :icon="getPointIcon(point)"
        :title="point.address"
        @click="showPointDetails(point)"
      />

      <!-- –õ–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ -->
      <YandexPolyline
        :coordinates="routeCoordinates"
        :stroke-color="'#007bff'"
        :stroke-width="3"
        :stroke-opacity="0.7"
      />
    </YandexMap>

    <!-- Popup —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–æ—á–∫–∏ -->
    <PointDetailsPopup
      v-if="selectedPoint"
      :point="selectedPoint"
      @close="selectedPoint = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import type { PublicTrackingResponse } from '@/types/tracking'

const props = defineProps<{
  courierLocation: PublicTrackingResponse['courierLocation']
  routePoints: PublicTrackingResponse['routePoints']
  transportationType: string
}>()

const selectedPoint = ref(null)

// –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
const mapCenter = computed(() => {
  if (props.courierLocation) {
    return [props.courierLocation.longitude, props.courierLocation.latitude]
  }

  // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
  const firstPoint = props.routePoints?.find(p => p.latitude && p.longitude)
  if (firstPoint) {
    return [firstPoint.longitude, firstPoint.latitude]
  }

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–ê—Å—Ç–∞–Ω–∞)
  return [71.4704, 51.1605]
})

// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞
const routeCoordinates = computed(() => {
  return props.routePoints
    ?.filter(p => p.latitude && p.longitude)
    .map(p => [p.longitude, p.latitude]) || []
})

// –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
const vehicleIcon = computed(() => {
  switch (props.transportationType) {
    case 'COURIER_DELIVERY':
      return '/icons/courier-van.svg'
    case 'FTL':
    case 'LTL':
      return '/icons/truck.svg'
    case 'BULK':
      return '/icons/bulk-truck.svg'
    case 'CITY':
      return '/icons/city-truck.svg'
    default:
      return '/icons/default-vehicle.svg'
  }
})

const getPointIcon = (point) => {
  if (point.isCompleted) {
    return '/icons/point-completed.svg'
  } else if (point.isCurrentPoint) {
    return '/icons/point-active.svg'
  }
  return '/icons/point-pending.svg'
}

const showPointDetails = (point) => {
  selectedPoint.value = point
}

const mapZoom = ref(12)

const onMapReady = (map) => {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ–¥ –≤—Å–µ —Ç–æ—á–∫–∏
  if (props.routePoints?.length > 1) {
    const bounds = calculateBounds()
    map.setBounds(bounds, { padding: 50 })
  }
}

const calculateBounds = () => {
  const points = [
    ...(props.courierLocation ? [[props.courierLocation.longitude, props.courierLocation.latitude]] : []),
    ...props.routePoints
      .filter(p => p.latitude && p.longitude)
      .map(p => [p.longitude, p.latitude])
  ]

  if (points.length === 0) return null

  const lats = points.map(p => p[1])
  const lngs = points.map(p => p[0])

  return [
    [Math.min(...lngs), Math.min(...lats)],
    [Math.max(...lngs), Math.max(...lats)]
  ]
}
</script>
```

---

## üß™ Testing Checklist

### Backend Tests

- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (FTL, LTL, CITY, BULK, COURIER_DELIVERY)
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
- [ ] –†–∞—Å—á–µ—Ç ETA –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- [ ] –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏

### Frontend Tests

- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–¥ –≤—Å–µ —Ç–æ—á–∫–∏
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
- [ ] Popup —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–æ—á–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
- [ ] –†–∞–∑–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

### Integration Tests

- [ ] E2E: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è FTL –∑–∞—è–≤–∫–∏ ‚Üí –æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ
- [ ] E2E: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ real-time –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ ETA –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π

---

## üìä Example Request/Response

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è FTL –∑–∞—è–≤–∫–∏

```http
POST /api/v1/tracking/management/transportations/67890/generate-link
Authorization: Bearer {token}
```

**Response:**
```json
{
  "transportationId": 67890,
  "trackingToken": "123e4567-e89b-12d3-a456-426614174000",
  "trackingUrl": "https://coube.kz/tracking/123e4567-e89b-12d3-a456-426614174000"
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏

```http
GET /api/v1/public/tracking/123e4567-e89b-12d3-a456-426614174000
```

**Response:**
```json
{
  "transportationId": 67890,
  "transportationType": "FTL",
  "transportationTypeDescription": "–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (FTL)",
  "status": "ON_THE_WAY",
  "statusDescription": "–í –ø—É—Ç–∏",
  "courierLocation": {
    "latitude": 51.2345,
    "longitude": 71.5678,
    "timestamp": "2025-12-04T10:30:00Z"
  },
  "courierInfo": {
    "fullName": "–í–æ–¥–∏—Ç–µ–ª—å –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "phone": "+77001234567"
  },
  "routePoints": [
    {
      "orderNum": 1,
      "address": "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è 10",
      "contactName": "–¢–û–û –ì—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
      "contactPhone": "+77001111111",
      "latitude": 51.1605,
      "longitude": 71.4704,
      "loadingType": "LOADING",
      "loadingDatetime": "2025-12-04T08:00:00",
      "weight": 20000,
      "weightUnit": "KG",
      "volume": 85,
      "commentary": "–ü–æ–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤",
      "isCompleted": true,
      "isCurrentPoint": false,
      "isDriverAtLocation": false,
      "orderCount": null
    },
    {
      "orderNum": 2,
      "address": "–≥. –ê–ª–º–∞—Ç—ã, —É–ª. –°–∫–ª–∞–¥—Å–∫–∞—è 25",
      "contactName": "–¢–û–û –ì—Ä—É–∑–æ–ø–æ–ª—É—á–∞—Ç–µ–ª—å",
      "contactPhone": "+77002222222",
      "latitude": 43.2220,
      "longitude": 76.8512,
      "loadingType": "UNLOADING",
      "loadingDatetime": "2025-12-05T14:00:00",
      "weight": 20000,
      "weightUnit": "KG",
      "volume": 85,
      "commentary": "–†–∞–∑–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∫–ª–∞–¥",
      "isCompleted": false,
      "isCurrentPoint": true,
      "isDriverAtLocation": false,
      "orderCount": null
    }
  ],
  "progress": {
    "totalPoints": 2,
    "completedPoints": 1,
    "currentPoint": 2,
    "percentage": 50.0
  },
  "eta": "2025-12-05T13:45:00",
  "createdAt": "2025-12-04T07:00:00"
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Rate Limiting**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 100 req/min –Ω–∞ IP
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ latitude (-90 –¥–æ 90) –∏ longitude (-180 –¥–æ 180)
3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (—Ü–µ–Ω—ã, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ID)
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ó–∞–ø–∏—Å—å –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

---

## üìù Notes

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Phase 1 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)**:
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ RoutePoint

2. **Phase 2 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)**:
   - –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç ETA –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ

3. **Phase 3 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**:
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Maps API –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è
   - Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–±—ã—Ç–∏–∏ –≤ —Ç–æ—á–∫—É
   - –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏

- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –µ—Å—Ç—å –≤ –ë–î (CargoLoadingHistory.location)
- –î–ª—è FTL/LTL –∑–∞—è–≤–æ–∫ –æ–±—ã—á–Ω–æ 2-3 —Ç–æ—á–∫–∏ (–∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞–∑–≥—Ä—É–∑–∫–∞)
- –î–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å 10-50 —Ç–æ—á–µ–∫
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

---

**Estimated**: 2-3 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + 1 –¥–µ–Ω—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
**Priority**: MEDIUM
**Dependencies**: –ó–∞–¥–∞—á–∞ #14 (–±–∞–∑–æ–≤—ã–π –ø—É–±–ª–∏—á–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥)