# API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ TEEZ - –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

## –°—É—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**Pull-–º–æ–¥–µ–ª—å (TEEZ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Coube)**:
```
TEEZ ‚Üí GET —Å—Ç–∞—Ç—É—Å—ã –ø–æ track_numbers ‚Üí Coube
        (polling –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç)
```

---

## –ü–æ—á–µ–º—É Pull-–º–æ–¥–µ–ª—å?

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. ‚úÖ TEEZ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ webhook endpoint –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ TEEZ
3. ‚úÖ –£–ø—Ä–æ—â–∞–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Coube (–Ω–µ—Ç –æ—á–µ—Ä–µ–¥–µ–π, –Ω–µ—Ç retry)
4. ‚úÖ TEEZ —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç retry-–ª–æ–≥–∏–∫–æ–π
5. ‚úÖ –°–Ω–∏–∂–∞–µ—Ç—Å—è coupling –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏
6. ‚úÖ –ü—Ä–æ—â–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?

### Endpoint –¥–ª—è TEEZ

**Endpoint**: `GET /api/v1/integration/courier/orders/status`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `track_numbers` (query) - —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–¥–æ 100)
- `source_system` (query) - default: `TEEZ_PVZ`

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: `X-API-Key` header

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**:
```bash
GET /api/v1/integration/courier/orders/status?track_numbers=TRACK-123,TRACK-456,TRACK-789&source_system=TEEZ_PVZ
X-API-Key: {teez-api-key}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞** (200 OK):
```json
{
  "orders": [
    {
      "track_number": "TRACK-123",
      "external_id": "ORDER-TEEZ-001",
      "status": "with_courier",
      "status_reason": null,
      "status_datetime": "2025-01-07T09:00:00Z",
      "delivery_datetime": null,
      "photo_url": null,
      "receiver_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
      "receiver_phone": "+77771234567",
      "delivery_address": "–ê–ª–º–∞—Ç—ã, –º–∫—Ä. –°–∞–º–∞–ª-2, –¥–æ–º 58",
      "courier_comment": null,
      "positions": [...]
    },
    {
      "track_number": "TRACK-456",
      "external_id": "ORDER-TEEZ-002",
      "status": "delivered",
      "status_reason": null,
      "status_datetime": "2025-01-07T14:05:00Z",
      "delivery_datetime": "2025-01-07T14:05:00Z",
      "photo_url": "https://s3.coube.kz/courier/photos/456.jpg",
      "positions": [...]
    },
    {
      "track_number": "TRACK-789",
      "external_id": "ORDER-TEEZ-003",
      "status": "not_delivered",
      "status_reason": "customer_not_available",
      "status_datetime": "2025-01-07T15:30:00Z",
      "delivery_datetime": null,
      "courier_comment": "–ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç",
      "positions": [...]
    }
  ],
  "not_found": ["TRACK-999"]
}
```

---

## –°—Ç–∞—Ç—É—Å—ã –¥–ª—è TEEZ

### 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞:

| Coube Status | TEEZ Mapping | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|--------------|--------------|-------------------|
| `with_courier` | "–ó–∞–∫–∞–∑ —É –∫—É—Ä—å–µ—Ä–∞" | –ö—É—Ä—å–µ—Ä –Ω–∞—á–∞–ª –º–∞—Ä—à—Ä—É—Ç |
| `delivered` | "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∫—É—Ä—å–µ—Ä–æ–º" | –£—Å–ø–µ—à–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ |
| `not_delivered` | "–ö—É—Ä—å–µ—Ä –Ω–µ —Å–º–æ–≥ –¥–æ—Å—Ç–∞–≤–∏—Ç—å" | –ù–µ–¥–æ—Å—Ç–∞–≤–∫–∞ (—Å –ø—Ä–∏—á–∏–Ω–æ–π) |
| `returned_to_sender` | "–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é" | –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∫–ª–∞–¥ TEEZ |

### –ü—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞–≤–∫–∏ (status_reason):

| Reason Code | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------|----------|
| `customer_not_available` | –ö–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω |
| `customer_refused` | –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è |
| `customer_postponed` | –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ |
| `address_not_found` | –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `other` | –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞ |

### –ö–∞–∫ —Ä–∞–∑–ª–∏—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã 3 –∏ 4?

**–°—Ç–∞—Ç—É—Å 3** (`not_delivered`):
- –ö—É—Ä—å–µ—Ä –Ω–µ —Å–º–æ–≥ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
- `status_reason` —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É
- –ó–∞–∫–∞–∑ –µ—â–µ —É –∫—É—Ä—å–µ—Ä–∞ –∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–æ–∑–≤—Ä–∞—Ç–∞

**–°—Ç–∞—Ç—É—Å 4** (`returned_to_sender`):
- –ó–∞–∫–∞–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å–∫–ª–∞–¥ TEEZ
- –ö—É—Ä—å–µ—Ä –æ—Ç–º–µ—Ç–∏–ª –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Ç–æ—á–∫–µ —Å `is_courier_warehouse: true`

---

## Backend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **Controller**: `CourierIntegrationController`
   - GET `/api/v1/integration/courier/orders/status`

2. **Service**: `CourierOrderStatusService`
   - `getOrdersStatus(trackNumbers, sourceSystem)`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤

3. **DTOs**:
   - `OrderStatusResponseDTO`
   - `OrderStatusDTO`
   - `PositionDTO`

4. **Database queries**:
   - –ó–∞–ø—Ä–æ—Å –ø–æ `track_number` –∏ `source_system`
   - –î–∂–æ–∏–Ω—ã —Å `courier_route_order`, `transportation`

---

## Rate Limiting

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
- ‚è±Ô∏è **60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É** –Ω–∞ API key
- ‚è±Ô∏è **1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å** –Ω–∞ API key
- üì¶ **100 —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–≤ –º–∞–∫—Å–∏–º—É–º** –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å

**Response –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏** (429):
```json
{
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "Rate limit exceeded. Try again later",
  "retry_after_seconds": 60
}
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è TEEZ

1. **–ß–∞—Å—Ç–æ—Ç–∞ polling**: –ö–∞–∂–¥—ã–µ **5-10 –º–∏–Ω—É—Ç**
2. **Batch requests**: –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–æ 100 —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–≤ –∑–∞ —Ä–∞–∑
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ not_found**: –ó–∞–∫–∞–∑ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä
4. **Retry policy**: –ü—Ä–∏ `429` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ exponential backoff
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤**:
   - `with_courier` ‚Üí –∑–∞–∫–∞–∑ –≤ –¥–æ—Å—Ç–∞–≤–∫–µ
   - `delivered` ‚Üí –∑–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
   - `not_delivered` ‚Üí —Å–º–æ—Ç—Ä–∏—Ç–µ `status_reason`
   - `returned_to_sender` ‚Üí –∑–∞–∫–∞–∑ –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å–∫–ª–∞–¥

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π flow

```
1. TEEZ —Å–æ–∑–¥–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç
   POST /api/v1/integration/waybills

2. TEEZ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π polling (–∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç)
   GET /api/v1/integration/courier/orders/status

3. TEEZ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É
   - with_courier ‚Üí "–ó–∞–∫–∞–∑ —É –∫—É—Ä—å–µ—Ä–∞"
   - delivered ‚Üí "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∫—É—Ä—å–µ—Ä–æ–º"
   - not_delivered ‚Üí "–ö—É—Ä—å–µ—Ä –Ω–µ —Å–º–æ–≥ –¥–æ—Å—Ç–∞–≤–∏—Ç—å"
   - returned_to_sender ‚Üí "–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é"

4. –ü—Ä–∏ 429 –æ—à–∏–±–∫–µ - exponential backoff
```

---

## –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è TEEZ

1. ‚ùì –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —á–∞—Å—Ç–æ—Ç–∞ polling –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç?
2. ‚ùì –°–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ –≤ —Å—Ä–µ–¥–Ω–µ–º –≤ –æ–¥–Ω–æ–º –º–∞—Ä—à—Ä—É—Ç–µ?
3. ‚ùì –ù—É–∂–µ–Ω –ª–∏ webhook-notification –≤–º–µ—Å—Ç–æ polling? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. ‚ùì –ö–∞–∫–æ–π timeout –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤?
5. ‚ùì –ù—É–∂–Ω–∞ –ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ (100+ –∑–∞–∫–∞–∑–æ–≤)?

---

## –°—Å—ã–ª–∫–∏

- **–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `03-api-examples.md` (—Ä–∞–∑–¥–µ–ª 2 –∏ 10)
- **–ü–æ–¥—Ä–æ–±–Ω—ã–π endpoint spec**: `07-webhook-results-endpoint.md`
- **–ë–î**: —Ç–∞–±–ª–∏—Ü—ã `courier_route_order`, `transportation`, `courier_integration_log`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-10-16
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-10-16
**–°—Ç–∞—Ç—É—Å**: Updated - Ready for Implementation

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

**16.10.2025**: –ò–∑–º–µ–Ω–µ–Ω –ø–æ–¥—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π TEEZ
- ‚ùå –£–±—Ä–∞–ª–∏ endpoint –ø–æ `waybill_id`
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ endpoint –ø–æ —Å–ø–∏—Å–∫—É `track_numbers`
- ‚úÖ –£–ø—Ä–æ—Å—Ç–∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è TEEZ (–∑–∞–ø—Ä–æ—Å –ø–æ –Ω–æ–º–µ—Ä–∞–º –∑–∞–∫–∞–∑–æ–≤)
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ 4 —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º TEEZ
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤ Coube ‚Üí TEEZ
