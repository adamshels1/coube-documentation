# 00. Сводка проекта биллинга

## Краткое описание

Внедрение системы биллинга на базе **Kill Bill** для монетизации платформы Coube через:
1. **Подписки** для Заказчиков (ежемесячная оплата)
2. **Агентскую модель** для Исполнителей (комиссия 5% от заявки)

## Ключевые цифры

| Параметр | Значение |
|----------|----------|
| Комиссия для Исполнителей | 5% от суммы заявки |
| Пробный период для новых клиентов | 1 месяц (настраиваемо) |
| Валюта по умолчанию | KZT (тенге) |
| Период подписки | Ежемесячно |
| Резервирование средств | При подписании заявки |
| Платёжные системы (Phase 1) | BCC |
| Платёжные системы (Phase 2) | Jusan, Kaspi, др. |

## Бизнес-правила

### 1. Определение "новых" vs "старых" клиентов

**Новый клиент** = впервые зарегистрировался на платформе.

**Важно**: Удаление учётной записи — **логическое** (soft delete). При повторной регистрации с теми же данными (company_name, email, phone) клиент считается **старым**.

**Реализация**:
```sql
-- При регистрации проверяем
SELECT id FROM users.organization 
WHERE (organization_name = ? OR iin_bin = ?) 
  AND deleted_at IS NOT NULL;

-- Если есть записи → клиент "старый"
-- Если нет → клиент "новый"
```

**Последствия**:
- **Новый клиент**: пробный тариф (trial period)
- **Старый клиент**: индивидуальные условия (отсрочка, частичная оплата)

### 2. Подписка для Заказчиков (модель 2A)

**Принцип**: Ежемесячная оплата за доступ ко всему функционалу.

**Баланс**:
- Баланс = **авансовый платёж** за услуги платформы
- Пополнение: выставление счёта (авто) или онлайн-оплата
- Списание: ежедневная амортизация

**Ежедневная амортизация**:
```
daily_cost = monthly_fee / days_in_current_month

Пример:
monthly_fee = 10,000₸
October (31 день): daily_cost = 10,000 / 31 = 322.58₸/день
February (28 дней): daily_cost = 10,000 / 28 = 357.14₸/день
```

**Отображение в ЛК**:
- Текущий баланс: 150,000₸
- Ежедневное списание: -322₸
- Доступно дней: 465 дней (~15 месяцев)
- Зарезервировано: 0₸

**Блокировка**:
- При `balance < 0` → временная блокировка:
  - Публикация новых заявок — запрещена
  - Просмотр истории — разрешён
  - Доступ к документам — разрешён

**Уведомления**:
- За 7 дней до окончания средств
- За 3 дня
- За 1 день
- При отрицательном балансе

### 3. Агентская модель для Исполнителей (модель 2B)

**Принцип**: Комиссия 5% от суммы заявки при её выполнении.

**Резервирование**:
- **Когда**: При подписании заявки Исполнителем
- **Сумма**: 5% от `transportation.cost`
- **Проверка**: `available_balance >= commission_amount`

**Зачисление (Capture)**:
- **Когда**: При подтверждении заявки второй стороной (Заказчиком)
- **Действие**: Зарезервированная сумма → баланс платформы
- **Документ**: Генерируется проводка

**Освобождение (Release)**:
- **Когда**: При отмене заявки
- **Важно**: Согласно оферте, при отмене возврат НЕ происходит → средства остаются у платформы
- **Исключение**: Отмена до подтверждения → release возможен (настраивается)

**Формула**:
```
commission_amount = transportation.cost * 0.05

Пример:
cost = 100,000₸
commission = 100,000 * 0.05 = 5,000₸
```

**Отображение в ЛК Исполнителя**:
- Баланс: 200,000₸
- Доступно: 190,000₸ (баланс - резервы)
- Зарезервировано: 10,000₸ (2 заявки по 5,000₸)

### 4. Пополнение баланса

**Способы**:
1. **Выставление счёта** (генерируется автоматически)
2. **Онлайн-оплата** через BCC/Jusan (Phase 2)

**Phase 1 (MVP)**: Ручное подтверждение админом
1. Клиент нажимает "Пополнить баланс" → вводит сумму
2. Система генерирует счёт (PDF) с реквизитами
3. Клиент оплачивает через банк (обычный перевод)
4. Админ видит платёж в выписке банка
5. Админ в админке Kill Bill подтверждает оплату вручную
6. Система увеличивает баланс клиента

**Phase 2 (Автоматизация)**: Webhook от PSP
1. Клиент нажимает "Оплатить онлайн"
2. Редирект на платёжный шлюз BCC
3. Оплата картой
4. PSP отправляет webhook на `/api/v1/billing/webhook/bcc`
5. Система проверяет подпись, увеличивает баланс
6. Генерируется АВР о поступлении средств

### 5. Документооборот

**Автоматически генерируемые документы**:

| Документ | Когда | Кто получатель |
|----------|-------|----------------|
| Счёт на оплату | При запросе пополнения баланса | Клиент |
| АВР (акт выполненных работ) | Ежемесячно за подписку | Заказчик |
| АВР (агентская комиссия) | Ежемесячно за комиссии | Исполнитель |
| Проводка | При любой фин. операции | Внутренний документ |
| Реестр платежей | По запросу / ежемесячно | Бухгалтерия |

**Формат**: PDF (генерация через библиотеку Apache PDFBox или iText)

**Хранение**: 
- MinIO/S3: сам файл
- `billing.document`: метаданные (invoice_id, type, file_url, created_at)

## Архитектура решения

### Компоненты

```
┌─────────────────────────────────────────────────────────────────┐
│                      Coube Platform (Spring Boot)                │
│                                                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌───────────────────┐  │
│  │  Applications  │  │  User Module   │  │  Billing Module   │  │
│  │    Module      │  │                │  │   (NEW)           │  │
│  └────────────────┘  └────────────────┘  └───────────────────┘  │
│           │                  │                      │             │
└───────────┼──────────────────┼──────────────────────┼─────────────┘
            │                  │                      │
            ▼                  ▼                      ▼
    ┌──────────────────────────────────────────────────────┐
    │              PostgreSQL (Platform DB)                 │
    │  schemas: applications, user, dictionaries, gis,      │
    │           factoring, notifications, file,             │
    │           billing (NEW)                               │
    └──────────────────────────────────────────────────────┘
                                        │
                                        │ REST API
                                        │ (WebClient)
                                        ▼
                            ┌─────────────────────┐
                            │     Kill Bill       │
                            │   (Billing Core)    │
                            │                     │
                            │  - Accounts         │
                            │  - Subscriptions    │
                            │  - Invoices         │
                            │  - Payments         │
                            │  - Plans/Catalogs   │
                            └─────────────────────┘
                                        │
                                        ▼
                            ┌─────────────────────┐
                            │    PostgreSQL       │
                            │   (Kill Bill DB)    │
                            └─────────────────────┘
```

### Разделение ответственности

**Kill Bill (биллинговое ядро)**:
- Управление подписками (создание, отмена, пауза)
- Генерация инвойсов по расписанию
- Учёт платежей
- Расчёт пропорциональных сумм (pro-rata)
- Каталог тарифных планов
- История всех биллинговых событий

**Coube Platform (бизнес-логика)**:
- Определение new/old клиентов
- Резервирование комиссии (hold/capture/release)
- Баланс и available_balance
- Связь биллинга с заявками (transportation)
- Генерация документов (АВР, счета)
- Уведомления пользователей
- Блокировка доступа при недостатке средств
- UI/UX для клиентов

### Схема базы данных (Coube)

**Новая схема**: `billing`

**Таблицы**:
1. `billing.account` - Связь пользователь ↔ Kill Bill аккаунт
2. `billing.subscription` - Локальная копия подписки
3. `billing.reservation` - Резервы комиссии (агентская модель)
4. `billing.transaction` - Все проводки
5. `billing.balance_history` - История изменения баланса
6. `billing.document` - Документы (АВР, счета)
7. `billing.webhook_log` - Лог webhook'ов от PSP

Детали в `01-database-schema.md`.

## API взаимодействие

### Platform → Kill Bill

**Основные вызовы**:
- `POST /1.0/kb/accounts` - Создать аккаунт
- `POST /1.0/kb/subscriptions` - Создать подписку
- `POST /1.0/kb/invoices/{invoiceId}/payments` - Зарегистрировать платёж
- `GET /1.0/kb/accounts/{accountId}/invoices` - Получить счета
- `GET /1.0/kb/accounts/{accountId}` - Информация об аккаунте

**Аутентификация**: Basic Auth (admin/password) или API Key

### Platform ← PSP (Payment Service Provider)

**Webhook endpoints**:
- `POST /api/v1/billing/webhook/bcc` - BCC
- `POST /api/v1/billing/webhook/jusan` - Jusan
- `POST /api/v1/billing/webhook/kaspi` - Kaspi

**Безопасность**: HMAC SHA256 signature verification

### Platform → Client (Frontend/Mobile)

**REST API**:
- `GET /api/v1/billing/balance` - Текущий баланс
- `POST /api/v1/billing/topup` - Запрос на пополнение
- `GET /api/v1/billing/invoices` - Список счетов
- `GET /api/v1/billing/transactions` - История операций
- `GET /api/v1/billing/documents/{id}` - Скачать документ

## Технологии

### Backend
- **Java**: 17+
- **Spring Boot**: 3.2+
- **Spring Data JPA**: для работы с БД
- **Spring WebClient**: для вызовов Kill Bill API
- **PostgreSQL**: 14+
- **Flyway**: миграции БД
- **Apache PDFBox** / **iText**: генерация PDF
- **Scheduler**: Spring @Scheduled для ежедневных джобов

### Kill Bill
- **Java**: 11+
- **Framework**: Custom (Dropwizard-based)
- **Database**: PostgreSQL (отдельная БД)
- **API**: JAX-RS (REST)
- **Admin UI**: React-based

### Infrastructure
- **Docker**: контейнеризация
- **Docker Compose**: оркестрация (Platform + Kill Bill + 2x PostgreSQL)
- **MinIO**: хранение документов
- **Nginx**: обратный прокси (опционально)

### Мониторинг
- **Spring Actuator**: healthcheck, metrics
- **Prometheus** (опционально): метрики
- **Grafana** (опционально): дашборды
- **Logs**: JSON-формат, ELK stack (опционально)

## Этапы реализации

### Phase 1: MVP (4 недели)

**Неделя 1-2: Инфраструктура и БД**
- [ ] Установка Kill Bill в Docker
- [ ] Создание схемы `billing` в Coube DB
- [ ] Flyway миграции для новых таблиц
- [ ] Базовая конфигурация Kill Bill (каталог тарифов)

**Неделя 3: Интеграция**
- [ ] Spring Service для вызовов Kill Bill API
- [ ] API создания биллинг-аккаунтов
- [ ] API подписок для Заказчиков
- [ ] API резервов для Исполнителей

**Неделя 4: UI и тестирование**
- [ ] Интеграция с существующими модулями (User, Applications)
- [ ] Отображение баланса в ЛК
- [ ] Ручное подтверждение оплаты админом
- [ ] Unit + Integration тесты
- [ ] Документация API (Swagger)

### Phase 2: Автоматизация (3 недели)

**Неделя 5: Платежи**
- [ ] Интеграция с BCC (webhook)
- [ ] Обработка callback'ов от PSP
- [ ] Автоматическое увеличение баланса

**Неделя 6: Автоматизация**
- [ ] Ежедневный job амортизации подписки
- [ ] Уведомления о низком балансе
- [ ] Автоматическая блокировка при balance < 0

**Неделя 7: Документы**
- [ ] Генерация АВР (подписка)
- [ ] Генерация АВР (комиссия)
- [ ] Хранение в MinIO
- [ ] API скачивания документов

### Phase 3: Продакшн (2 недели)

**Неделя 8: Доработки**
- [ ] Интеграция с Jusan, Kaspi
- [ ] Админка для управления тарифами
- [ ] Отчёты для бухгалтерии
- [ ] Резервное копирование БД

**Неделя 9: Деплой**
- [ ] Нагрузочное тестирование
- [ ] Security аудит
- [ ] Мониторинг и алертинг
- [ ] Production deployment

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Kill Bill сложен в настройке | Высокая | Среднее | Использовать официальный Docker образ, изучить документацию заранее |
| Несовместимость версий PostgreSQL | Низкая | Высокое | Использовать рекомендуемую версию (PostgreSQL 12+) |
| Проблемы с webhook от PSP | Средняя | Высокое | Retry mechanism, логирование, ручной fallback (Phase 1) |
| Сложность резервов (hold/capture) | Средняя | Среднее | Реализовать в Platform, а не в Kill Bill |
| Генерация PDF тормозит | Низкая | Низкое | Асинхронная генерация через очередь (RabbitMQ) |

## Метрики успеха

**Технические**:
- [ ] Uptime Kill Bill >= 99.9%
- [ ] Latency API < 200ms (95 percentile)
- [ ] Успешность webhook обработки >= 99%
- [ ] Отсутствие двойного списания (idempotency)

**Бизнесовые**:
- [ ] 100% корректность расчёта комиссии
- [ ] Все документы генерируются автоматически
- [ ] Уведомления доходят за 7 дней до блокировки
- [ ] Баланс всегда актуален (real-time)

## Чеклист перед деплоем

**Инфраструктура**:
- [ ] Docker Compose настроен и работает
- [ ] PostgreSQL (Platform) и PostgreSQL (Kill Bill) изолированы
- [ ] Healthcheck для всех контейнеров
- [ ] Логи пишутся в JSON-формат
- [ ] Резервное копирование БД настроено

**Безопасность**:
- [ ] mTLS для Platform ↔ Kill Bill
- [ ] JWT токены для API
- [ ] Подпись webhook проверяется (HMAC SHA256)
- [ ] Secrets не в коде (env variables)
- [ ] Аудит всех финансовых операций

**Функциональность**:
- [ ] Новые/старые клиенты определяются корректно
- [ ] Пробный период работает
- [ ] Ежедневная амортизация списывается
- [ ] Резервы hold/capture/release работают
- [ ] Уведомления отправляются
- [ ] Документы генерируются и хранятся

**Тестирование**:
- [ ] Unit тесты покрытие >= 80%
- [ ] Integration тесты для критичных сценариев
- [ ] Нагрузочное тестирование (1000 RPS)
- [ ] Тест ручного подтверждения оплаты
- [ ] Тест webhook от PSP (mock)

**Документация**:
- [ ] README с инструкциями по установке
- [ ] Swagger API документация
- [ ] Руководство для админа
- [ ] Диаграммы архитектуры

## Следующие шаги

1. ✅ Ознакомиться с текущим документом
2. → Перейти к `01-database-schema.md` для детализации БД
3. → Изучить `02-killbill-setup.md` для установки
4. → Реализовать согласно чеклисту `16-implementation-checklist.md`

---

**Документ подготовлен**: 2025-01-XX  
**Версия**: 1.0  
**Автор**: Backend Team
